var JSON=function(){var m={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},s={"boolean":function(x){return String(x)},number:function(x){return isFinite(x)?String(x):"null"},string:function(x){if(/["\\\x00-\x1f]/.test(x)){x=x.replace(/([\x00-\x1f\\"])/g,function(a,b){var c=m[b];if(c){return c}c=b.charCodeAt();return"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16)})}return'"'+x+'"'},object:function(x){if(x){var a=[],b,f,i,l,v;if(x instanceof Array){a[0]="[";l=x.length;for(i=0;i<l;i+=1){v=x[i];f=s[typeof v];if(f){v=f(v);if(typeof v=="string"){if(b){a[a.length]=","}a[a.length]=v;b=true}}}a[a.length]="]"}else{if(x instanceof Object){a[0]="{";for(i in x){v=x[i];f=s[typeof v];if(f){v=f(v);if(typeof v=="string"){if(b){a[a.length]=","}a.push(s.string(i),":",v);b=true}}}a[a.length]="}"}else{return }}return a.join("")}return"null"}};return{copyright:"(c)2005 JSON.org",license:"http://www.crockford.com/JSON/license.html",stringify:function(v){var f=s[typeof v];
if(f){v=f(v);if(typeof v=="string"){return v}}return null},eval:function(text){try{return !(/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(text.replace(/"(\\.|[^"\\])*"/g,"")))&&eval("("+text+")")}catch(e){return false}},parse:function(text){var at=0;var ch=" ";function error(m){throw {name:"JSONError",message:m,at:at-1,text:text}}function next(){ch=text.charAt(at);at+=1;return ch}function white(){while(ch){if(ch<=" "){next()}else{if(ch=="/"){switch(next()){case"/":while(next()&&ch!="\n"&&ch!="\r"){}break;case"*":next();for(;;){if(ch){if(ch=="*"){if(next()=="/"){next();break}}else{next()}}else{error("Unterminated comment")}}break;default:error("Syntax error")}}else{break}}}}function string(){var i,s="",t,u;if(ch=='"'){outer:while(next()){if(ch=='"'){next();return s}else{if(ch=="\\"){switch(next()){case"b":s+="\b";break;case"f":s+="\f";break;case"n":s+="\n";break;case"r":s+="\r";break;case"t":s+="\t";break;case"u":u=0;for(i=0;i<4;i+=1){t=parseInt(next(),16);if(!isFinite(t)){break outer}u=u*16+t
}s+=String.fromCharCode(u);break;default:s+=ch}}else{s+=ch}}}}error("Bad string")}function array(){var a=[];if(ch=="["){next();white();if(ch=="]"){next();return a}while(ch){a.push(value());white();if(ch=="]"){next();return a}else{if(ch!=","){break}}next();white()}}error("Bad array")}function object(){var k,o={};if(ch=="{"){next();white();if(ch=="}"){next();return o}while(ch){k=string();white();if(ch!=":"){break}next();o[k]=value();white();if(ch=="}"){next();return o}else{if(ch!=","){break}}next();white()}}error("Bad object")}function number(){var n="",v;if(ch=="-"){n="-";next()}while(ch>="0"&&ch<="9"){n+=ch;next()}if(ch=="."){n+=".";while(next()&&ch>="0"&&ch<="9"){n+=ch}}if(ch=="e"||ch=="E"){n+="e";next();if(ch=="-"||ch=="+"){n+=ch;next()}while(ch>="0"&&ch<="9"){n+=ch;next()}}v=+n;if(!isFinite(v)){}else{return v}}function word(){switch(ch){case"t":if(next()=="r"&&next()=="u"&&next()=="e"){next();return true}break;case"f":if(next()=="a"&&next()=="l"&&next()=="s"&&next()=="e"){next();return false
}break;case"n":if(next()=="u"&&next()=="l"&&next()=="l"){next();return null}break}error("Syntax error")}function value(){white();switch(ch){case"{":return object();case"[":return array();case'"':return string();case"-":return number();default:return ch>="0"&&ch<="9"?number():word()}}return value()}}}();document.iframeLoaders={};iframe=function(){this.initialize.apply(this,arguments)};iframe.prototype={initialize:function(form,options,count){if(!options){options={}}this.form=form;this.uniqueId=count;document.iframeLoaders[this.uniqueId]=this;this.transport=this.getTransport();this.onComplete=options.onComplete||null;this.update=this.$(options.update)||null;this.updateMultiple=options.multiple||false;if(((navigator.vendor&&(navigator.vendor.indexOf("Apple"))>-1)||window.opera)&&(/\/Direct\/Process(\?|$)/.test(form.action))&&form.elements&&(form.elements.length==1)){var url=form.action+"?jsonRequest="+encodeURIComponent(form.elements[0].value),doc=this.transport.contentWindow||this.transport.contentDocument;
if(url.length<80000){if(doc.document){doc=doc.document}try{doc.location.replace(url);return }catch(e){}}}form.target="frame_"+this.uniqueId;form.setAttribute("target","frame_"+this.uniqueId);form.submit()},onStateChange:function(){this.transport=this.$("frame_"+this.uniqueId);try{var doc=this.transport.contentDocument.document.body.innerHTML;this.transport.contentDocument.document.close()}catch(e){try{var doc=this.transport.contentWindow.document.body.innerHTML;this.transport.contentWindow.document.close()}catch(e){try{var doc=this.transport.document.body.innerHTML;this.transport.document.body.close()}catch(e){try{var doc=window.frames["frame_"+this.uniqueId].document.body.innerText}catch(e){}}}}this.transport.responseText=doc;if(this.onComplete){setTimeout(this.bind(function(){this.onComplete(this.transport)},this),10)}if(this.update){setTimeout(this.bind(function(){this.update.innerHTML=this.transport.responseText},this),10)}if(this.updateMultiple){setTimeout(this.bind(function(){try{var hasscript=false;
eval("var inputObject = "+this.transport.responseText);for(var i in inputObject){if(i=="script"){hasscript=true}else{if(elm=this.$(i)){elm.innerHTML=inputObject[i]}else{}}}if(hasscript){eval(inputObject.script)}}catch(e){}},this),10)}},getTransport:function(){var divElm=document.createElement("DIV"),frame;divElm.setAttribute("style","width: 0; height: 0; margin: 0; padding: 0; visibility: hidden; overflow: hidden");if(navigator.userAgent.indexOf("MSIE")>0&&navigator.userAgent.indexOf("Opera")==-1){divElm.style.width=0;divElm.style.height=0;divElm.style.margin=0;divElm.style.padding=0;divElm.style.visibility="hidden";divElm.style.overflow="hidden";divElm.innerHTML='<iframe name="frame_'+this.uniqueId+'" id="frame_'+this.uniqueId+'" src="about:blank" onload="setTimeout(function(){document.iframeLoaders['+this.uniqueId+'].onStateChange()},20);"></iframe>'}else{frame=document.createElement("iframe");frame.setAttribute("name","frame_"+this.uniqueId);frame.setAttribute("id","frame_"+this.uniqueId);
frame.addEventListener("load",this.bind(function(){this.onStateChange()},this),false);divElm.appendChild(frame)}document.body.appendChild(divElm);return frame},bind:function(functionObject,referenceObject){return function(){return functionObject.apply(referenceObject,arguments)}},"$":function(id){return document.getElementById(id)}};RequestBatch=function(){this.initialize.apply(this,arguments)};var counter=0;var pendingRequests=0;function DirectAccessErrorHandler(msg,ex){}RequestBatch.prototype={initialize:function(){this.UniqueId=counter++;this.Requests=new Array()},AddToRequest:function(requestThis){this.Requests[this.Requests.length]=requestThis},BeginRequest:function(serverUrl,callback){pendingRequests++;var jsonString=JSON.stringify(this),ie=
/*@cc_on!@*/
false;if(ie&&!RequestBatch.container){var body=document.body,div;RequestBatch.container=div=body.insertBefore(document.createElement("div"),body.firstChild);div.style.height=div.style.width=div.style.margin=div.style.padding=0;div.style.visibility=div.style.overflow="hidden"
}var form=generateForm(this.UniqueId,serverUrl,jsonString);new iframe(form,{onComplete:function(request){processResponse(callback,request)}},this.UniqueId);this.UniqueId=counter++}};function generateForm(formId,serverUrl,inputVal){var form=document.createElement("form");form.acceptCharset="UTF-8";form.name="f"+formId;form.id="f"+formId;form.action=serverUrl;var inputElem=document.createElement("input");inputElem.name="jsonRequest";inputElem.type="hidden";inputElem.value=inputVal;form.appendChild(inputElem);form.method="post";if(navigator.userAgent.toLowerCase().indexOf("firefox")!=-1){var separator=serverUrl.indexOf("?")==-1?"?":"&";var fullRequestURL=serverUrl+separator+"jsonRequest="+escape(inputVal);if(fullRequestURL.length<15000){var sidPos=serverUrl.indexOf("sid=");if(sidPos!=-1){var endPos=serverUrl.indexOf("&",sidPos);var sid=serverUrl.substring(sidPos+"sid=".length,endPos==-1?serverUrl.length:endPos);var sidInputElem=document.createElement("input");sidInputElem.name="sid";sidInputElem.type="hidden";
sidInputElem.value=sid;form.appendChild(sidInputElem);form.action=serverUrl.substring(0,sidPos-1)}form.method="get"}}(RequestBatch.container||document.body).appendChild(form);return form}function processResponse(callback,request){pendingRequests--;try{var jsonResponse=unescape(request.responseText);var responseObject=JSON.parse(jsonResponse);try{callback(responseObject.ResponseBatch)}catch(e){DirectAccessErrorHandler("exception during client callback",e)}}catch(e){DirectAccessErrorHandler("exception during processResponse",e)}}function getPendingRequestCount(){return pendingRequests}(function(){var Class=function(){return function(){this.initialize.apply(this,arguments)}};UserKey=Class();UserKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.UserKey=data}};CommentKey=Class();CommentKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.CommentKey=data}};ArticleKey=Class();ArticleKey.prototype={initialize:function(key){var data=new Object();
data.Key=key;this.ArticleKey=data}};PersonaMessageKey=Class();PersonaMessageKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.PersonaMessageKey=data}};ReviewKey=Class();ReviewKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.ReviewKey=data}};GalleryKey=Class();GalleryKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.GalleryKey=data}};PhotoKey=Class();PhotoKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.PhotoKey=data}};VideoKey=Class();VideoKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.VideoKey=data}};BlogKey=Class();BlogKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.BlogKey=data}};BlogPostKey=Class();BlogPostKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.BlogPostKey=data}};CustomItemKey=Class();CustomItemKey.prototype={initialize:function(key){var data=new Object();data.Key=key;
this.CustomItemKey=data}};CustomCollectionKey=Class();CustomCollectionKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.CustomCollectionKey=data}};ForumKey=Class();ForumKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.ForumKey=data}};DiscussionKey=Class();DiscussionKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.DiscussionKey=data}};ForumPostKey=Class();ForumPostKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.ForumPostKey=data}};EventKey=Class();EventKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.EventKey=data}};EventSetKey=Class();EventSetKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.EventSetKey=data}};CommunityGroupKey=Class();CommunityGroupKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.CommunityGroupKey=data}};CommunityGroupMembershipKey=Class();CommunityGroupMembershipKey.prototype={initialize:function(communityGroupKey,userKey){var data=new Object();
data.CommunityGroupKey=communityGroupKey;data.UserKey=userKey;this.CommunityGroupMembershipKey=data}};CommunityGroupInvitationKey=Class();CommunityGroupInvitationKey.prototype={initialize:function(communityGroupKey,userKey){var data=new Object();data.CommunityGroupKey=communityGroupKey;data.UserKey=userKey;this.CommunityGroupInvitationKey=data}};CommunityGroupRegistrantKey=Class();CommunityGroupRegistrantKey.prototype={initialize:function(communityGroupKey,userKey){var data=new Object();data.CommunityGroupKey=communityGroupKey;data.UserKey=userKey;this.CommunityGroupRegistrantKey=data}};CommunityGroupBannedUserKey=Class();CommunityGroupBannedUserKey.prototype={initialize:function(communityGroupKey,userKey){var data=new Object();data.CommunityGroupKey=communityGroupKey;data.UserKey=userKey;this.CommunityGroupBannedUserKey=data}};CommentPage=Class();CommentPage.prototype={initialize:function(articleKey,numberPerPage,onPage,sort){var data=new Object();data.ArticleKey=articleKey;data.NumberPerPage=numberPerPage;
data.OnPage=onPage;data.Sort=sort;this.CommentPage=data}};PersonaMessagePage=Class();PersonaMessagePage.prototype={initialize:function(userKey,numberPerPage,onPage,sort){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.PersonaMessagePage=data}};ReviewPage=Class();ReviewPage.prototype={initialize:function(articleKey,numberPerPage,onPage,sort){var data=new Object();data.ArticleKey=articleKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.ReviewPage=data}};MediaType=Class();MediaType.prototype={initialize:function(name){var data=new Object();data.Name=name;this.MediaType=data}};PublicGalleryPage=Class();PublicGalleryPage.prototype={initialize:function(numberPerPage,onPage,mediaType){var data=new Object();data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.MediaType=mediaType;this.PublicGalleryPage=data}};UserGalleryPage=Class();UserGalleryPage.prototype={initialize:function(userKey,numberPerPage,onPage,mediaType){var data=new Object();
data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.MediaType=mediaType;this.UserGalleryPage=data}};PhotoPage=Class();PhotoPage.prototype={initialize:function(galleryKey,numberPerPage,onPage,sort){var data=new Object();data.GalleryKey=galleryKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.PhotoPage=data}};VideoPage=Class();VideoPage.prototype={initialize:function(galleryKey,numberPerPage,onPage,sort){var data=new Object();data.GalleryKey=galleryKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.VideoPage=data}};CommentAction=Class();CommentAction.prototype={initialize:function(commentOnKey,onPageUrl,onPageTitle,commentBody){var data=new Object();data.CommentOnKey=commentOnKey;data.OnPageUrl=onPageUrl;data.OnPageTitle=onPageTitle;data.CommentBody=commentBody;this.CommentAction=data}};ReviewAction=Class();ReviewAction.prototype={initialize:function(reviewOnThisKey,onPageUrl,onPageTitle,reviewTitle,reviewRating,reviewBody,reviewPros,reviewCons){var data=new Object();
data.ReviewOnKey=reviewOnThisKey;data.OnPageUrl=onPageUrl;data.OnPageTitle=onPageTitle;data.ReviewTitle=reviewTitle;data.ReviewRating=reviewRating;data.ReviewBody=reviewBody;data.ReviewPros=reviewPros;data.ReviewCons=reviewCons;this.ReviewAction=data}};RecommendAction=Class();RecommendAction.prototype={initialize:function(recommendThisKey){var data=new Object();data.RecommendThisKey=recommendThisKey;this.RecommendAction=data}};RateAction=Class();RateAction.prototype={initialize:function(rateThisKey,rating){var data=new Object();data.RateThisKey=rateThisKey;data.Rating=rating;this.RateAction=data}};DeleteContentAction=Class();DeleteContentAction.prototype={initialize:function(deleteThisContent){var data=new Object();data.DeleteThisContent=deleteThisContent;this.DeleteContentAction=data}};EmailContentAction=Class();EmailContentAction.prototype={initialize:function(toAddress,subject,body){var data=new Object();data.ToAddress=toAddress;data.Subject=subject;data.Body=body;this.EmailContentAction=data
}};EmailContentWithUserIDAction=Class();EmailContentWithUserIDAction.prototype={initialize:function(toUserKey,subject,body){var data=new Object();data.UserKey=toUserKey;data.Subject=subject;data.Body=body;this.EmailContentWithUserIDAction=data}};ReportAbuseAction=Class();ReportAbuseAction.prototype={initialize:function(reportThisKey,abuseReason,abuseDescription){var data=new Object();data.ReportThisKey=reportThisKey;data.AbuseReason=abuseReason;data.AbuseDescription=abuseDescription;this.ReportAbuseAction=data}};Category=Class();Category.prototype={initialize:function(name){var data=new Object();data.Name=name;this.Category=data}};Section=Class();Section.prototype={initialize:function(name){var data=new Object();data.Name=name;this.Section=data}};UpdateArticleAction=Class();UpdateArticleAction.prototype={initialize:function(updateArticle,onPageUrl,onPageTitle,section,categories){var data=new Object();data.UpdateArticle=updateArticle;data.OnPageUrl=onPageUrl;data.OnPageTitle=onPageTitle;
data.Section=section;data.Categories=categories;this.UpdateArticleAction=data}};UpdateGalleryAction=Class();UpdateGalleryAction.prototype={initialize:function(updateGallery,galleryType,mediaType,title,description,tags,section,galleryPromo){var data=new Object();data.UpdateGallery=updateGallery;data.GalleryType=galleryType;data.MediaType=mediaType;data.Title=title;data.Description=description;data.Tags=tags;data.Section=section;data.GalleryPromo=galleryPromo;this.UpdateGalleryAction=data}};UpdatePhotoAction=Class();UpdatePhotoAction.prototype={initialize:function(updatePhoto,title,description,tags,section){var data=new Object();data.UpdatePhoto=updatePhoto;data.Title=title;data.Description=description;data.Tags=tags;data.Section=section;this.UpdatePhotoAction=data}};UpdateVideoAction=Class();UpdateVideoAction.prototype={initialize:function(updateVideo,title,description,tags,section){var data=new Object();data.UpdateVideo=updateVideo;data.Title=title;data.Description=description;data.Tags=tags;
data.Section=section;this.UpdateVideoAction=data}};GalleryType=Class();GalleryType.prototype={initialize:function(name){var data=new Object();data.Name=name;this.GalleryType=data}};GalleryPromo=Class();GalleryPromo.prototype={initialize:function(title,body,photoKey){var data=new Object();data.Title=title;data.Body=body;data.PhotoKey=photoKey;this.GalleryPromo=data}};UserTier=Class();UserTier.prototype={initialize:function(name){var data=new Object();data.Name=name;this.UserTier=data}};MembershipTier=Class();MembershipTier.prototype={initialize:function(name){var data=new Object();data.Name=name;this.MembershipTier=data}};Activity=Class();Activity.prototype={initialize:function(name){var data=new Object();data.Name=name;this.Activity=data}};DiscoverArticlesAction=Class();DiscoverArticlesAction.prototype={initialize:function(searchSections,searchCategories,limitToContributors,activity,age,maximumNumberOfDiscoveries){var data=new Object();data.SearchSections=searchSections;data.SearchCategories=searchCategories;
data.LimitToContributors=limitToContributors;data.Activity=activity;data.Age=age;data.MaximumNumberOfDiscoveries=maximumNumberOfDiscoveries;this.DiscoverArticlesAction=data}};AddFriendAction=Class();AddFriendAction.prototype={initialize:function(friendUserKey){var data=new Object();data.FriendUserKey=friendUserKey;this.AddFriendAction=data}};AddPersonaMessageAction=Class();AddPersonaMessageAction.prototype={initialize:function(toUserKey,body){var data=new Object();data.ToUserKey=toUserKey;data.Body=body;this.AddPersonaMessageAction=data}};RemovePersonaMessageAction=Class();RemovePersonaMessageAction.prototype={initialize:function(personaMessageKey){var data=new Object();data.PersonaMessageKey=personaMessageKey;this.RemovePersonaMessageAction=data}};ApproveFriendAction=Class();ApproveFriendAction.prototype={initialize:function(friendUserKey,isApproved){var data=new Object();data.FriendUserKey=friendUserKey;data.IsApproved=isApproved;this.ApproveFriendAction=data}};RemoveFriendAction=Class();
RemoveFriendAction.prototype={initialize:function(friendUserKey){var data=new Object();data.FriendUserKey=friendUserKey;this.RemoveFriendAction=data}};AddEnemyAction=Class();AddEnemyAction.prototype={initialize:function(enemyUserKey){var data=new Object();data.EnemyUserKey=enemyUserKey;this.AddEnemyAction=data}};RemoveEnemyAction=Class();RemoveEnemyAction.prototype={initialize:function(enemyUserKey){var data=new Object();data.EnemyUserKey=enemyUserKey;this.RemoveEnemyAction=data}};FriendPage=Class();FriendPage.prototype={initialize:function(userKey,numberPerPage,onPage,isPendingList){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.IsPendingList=isPendingList;this.FriendPage=data}};IsFriend=Class();IsFriend.prototype={initialize:function(friendUserKey,userKey){var data=new Object();data.FriendUserKey=friendUserKey;data.UserKey=userKey;this.IsFriend=data}};DiscoverContentAction=Class();DiscoverContentAction.prototype={initialize:function(searchSections,searchCategories,limitToContributors,activity,contentType,age,maximumNumberOfDiscoveries,filterBySiteOfOrigin){var data=new Object();
data.SearchSections=searchSections;data.SearchCategories=searchCategories;data.LimitToContributors=limitToContributors;data.Activity=activity;data.ContentType=contentType;data.Age=age;data.MaximumNumberOfDiscoveries=maximumNumberOfDiscoveries;data.FilterBySiteOfOrigin=filterBySiteOfOrigin;this.DiscoverContentAction=data}};ContentType=Class();ContentType.prototype={initialize:function(name){var data=new Object();data.Name=name;this.ContentType=data}};UpdateUserProfileAction=Class();UpdateUserProfileAction.prototype={initialize:function(userKey,aboutMe,location,signature,dateOfBirth,sex,personaPrivacyMode,commentsTabVisible,photosTabVisible,messagesOpenToEveryone,isEmailNotificationsEnabled,selectedStyleId,customAnswers,extendedProfile){var data=new Object();data.UserKey=userKey;data.AboutMe=aboutMe;data.Location=location;data.Signature=signature;data.DateOfBirth=dateOfBirth;data.Sex=sex;data.PersonaPrivacyMode=personaPrivacyMode;data.CommentsTabVisible=commentsTabVisible;data.PhotosTabVisible=photosTabVisible;
data.MessagesOpenToEveryone=messagesOpenToEveryone;data.IsEmailNotificationsEnabled=isEmailNotificationsEnabled;data.SelectedStyleId=selectedStyleId;data.CustomAnswers=customAnswers;data.ExtendedProfile=extendedProfile;this.UpdateUserProfileAction=data}};SearchAction=Class();SearchAction.prototype={initialize:function(searchType,searchString,numberPerPage,onPage){var data=new Object();data.SearchType=searchType;data.SearchString=searchString;data.NumberPerPage=numberPerPage;data.OnPage=onPage;this.SearchAction=data}};WatchItemPage=Class();WatchItemPage.prototype={initialize:function(userKey,numberPerPage,onPage){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;this.WatchItemPage=data}};AddWatchItemAction=Class();AddWatchItemAction.prototype={initialize:function(userKey,watchTargetKey,title,url){var data=new Object();data.UserKey=userKey;data.WatchTargetKey=watchTargetKey;data.WatchItemTitle=title;data.WatchItemUrl=url;this.AddWatchItemAction=data
}};DeleteWatchItemAction=Class();DeleteWatchItemAction.prototype={initialize:function(userKey,watchTargetKey){var data=new Object();data.UserKey=userKey;data.WatchTargetKey=watchTargetKey;this.DeleteWatchItemAction=data}};BlogPostPage=Class();BlogPostPage.prototype={initialize:function(blogKey,numberPerPage,onPage,sort,blogPostState){var data=new Object();data.BlogKey=blogKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;data.BlogPostState=blogPostState;this.BlogPostPage=data}};BlogPostsByTagPage=Class();BlogPostsByTagPage.prototype={initialize:function(blogKey,tag,numberPerPage,onPage,sort){var data=new Object();data.BlogKey=blogKey;data.Tag=tag;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.BlogPostsByTagPage=data}};BlogPostArchiveCount=Class();BlogPostArchiveCount.prototype={initialize:function(blogKey){var data=new Object();data.BlogKey=blogKey;this.BlogPostArchiveCount=data}};BlogPostArchiveContentPage=Class();BlogPostArchiveContentPage.prototype={initialize:function(blogKey,month,numberPerPage,onPage,sort){var data=new Object();
data.BlogKey=blogKey;data.Month=month;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.BlogPostArchiveContentPage=data}};UserCommentPage=Class();UserCommentPage.prototype={initialize:function(userKey,numberPerPage,onPage,sort){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.UserCommentPage=data}};RecentBlogTag=Class();RecentBlogTag.prototype={initialize:function(blogKey){var data=new Object();data.BlogKey=blogKey;this.RecentBlogTag=data}};RecentUserPhotoPage=Class();RecentUserPhotoPage.prototype={initialize:function(userKey,numberPerPage,onPage){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;this.RecentUserPhotoPage=data}};RecentUserVideoPage=Class();RecentUserVideoPage.prototype={initialize:function(userKey,numberPerPage,onPage){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;this.RecentUserVideoPage=data
}};RecentPublicGalleryPage=Class();RecentPublicGalleryPage.prototype={initialize:function(userKey,numberPerPage,onPage){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;this.RecentPublicGalleryPage=data}};RecentUserActivity=Class();RecentUserActivity.prototype={initialize:function(userKey){var data=new Object();data.UserKey=userKey;this.RecentUserActivity=data}};UserMediaSubmissionsCountPage=Class();UserMediaSubmissionsCountPage.prototype={initialize:function(userKey,mediaType,numberPerPage,onPage){var data=new Object();data.UserKey=userKey;data.MediaType=mediaType;data.NumberPerPage=numberPerPage;data.OnPage=onPage;this.UserMediaSubmissionsCountPage=data}};RecentForumDiscussionPage=Class();RecentForumDiscussionPage.prototype={initialize:function(userKey,numberPerPage,onPage){var data=new Object();data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;this.RecentForumDiscussionPage=data}};UserGroupForumPage=Class();UserGroupForumPage.prototype={initialize:function(userKey,numberPerPage,onPage,sort){var data=new Object();
data.UserKey=userKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.UserGroupForumPage=data}};BlogRollEntry=Class();BlogRollEntry.prototype={initialize:function(name,url){var data=new Object();data.Name=name;data.Url=url;this.BlogRollEntry=data}};Bookmark=Class();Bookmark.prototype={initialize:function(title,link){var data=new Object();data.Title=title;data.Link=link;this.Bookmark=data}};CommunityGroupVisibility=Class();CommunityGroupVisibility.prototype={initialize:function(name){var data=new Object();data.Name=name;this.CommunityGroupVisibility=data}};UpdateBlogAction=Class();UpdateBlogAction.prototype={initialize:function(updateBlog,title,tagline,blogRollEntries,blogType){var data=new Object();data.BlogKey=updateBlog;data.Title=title;data.Tagline=tagline;data.BlogRollEntries=blogRollEntries;data.BlogType=blogType;this.UpdateBlogAction=data}};UpdateBlogPostAction=Class();UpdateBlogPostAction.prototype={initialize:function(key,title,body,tags,publishDate,published){var data=new Object();
data.TargetThis=key;data.Title=title;data.Body=body;data.Tags=tags;data.Date=publishDate;data.Published=published;this.UpdateBlogPostAction=data}};DiscussionKey=Class();DiscussionKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.DiscussionKey=data}};CustomItemKey=Class();CustomItemKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.CustomItemKey=data}};CustomCollectionKey=Class();CustomCollectionKey.prototype={initialize:function(key){var data=new Object();data.Key=key;this.CustomCollectionKey=data}};UpdateCustomItemAction=Class();UpdateCustomItemAction.prototype={initialize:function(customItemKey,name,mimeType,displayText,content,includeInRecentActivity){var data=new Object();data.CustomItemKey=customItemKey;data.Name=name;data.MimeType=mimeType;data.DisplayText=displayText;data.Content=content;if((typeof (includeInRecentActivity)=="undefined")||(includeInRecentActivity==null)){includeInRecentActivity=true}data.IncludeInRecentActivity=includeInRecentActivity;
this.UpdateCustomItemAction=data}};AddCustomCollectionAction=Class();AddCustomCollectionAction.prototype={initialize:function(customCollectionKey,customCollectionName){var data=new Object();data.CustomCollectionKey=customCollectionKey;data.CustomCollectionName=customCollectionName;this.AddCustomCollectionAction=data}};InsertIntoCollectionAction=Class();InsertIntoCollectionAction.prototype={initialize:function(customCollectionKey,insertThisKey,position){var data=new Object();data.CustomCollectionKey=customCollectionKey;data.InsertThisKey=insertThisKey;data.Position=position;this.InsertIntoCollectionAction=data}};RemoveFromCollectionAction=Class();RemoveFromCollectionAction.prototype={initialize:function(customCollectionKey,removeThisKey,position){var data=new Object();data.CustomCollectionKey=customCollectionKey;data.RemoveThisKey=removeThisKey;data.Position=position;this.RemoveFromCollectionAction=data}};CustomCollectionPage=Class();CustomCollectionPage.prototype={initialize:function(customCollectionKey,numberPerPage,onPage,sort){var data=new Object();
data.CustomCollectionKey=customCollectionKey;data.NumberPerPage=numberPerPage;data.OnPage=onPage;data.Sort=sort;this.CustomCollectionPage=data}};EditorMessageRequest=Class();EditorMessageRequest.prototype={initialize:function(){this.EditorMessageRequest=new Object()}};UserTags=Class();UserTags.prototype={initialize:function(userKey,contentType){var data=new Object();data.UserKey=userKey;data.ContentType=contentType;this.UserTags=data}};GetContentPolicyAction=Class();GetContentPolicyAction.prototype={initialize:function(targetKey,userTier,action){var data=new Object();data.TargetKey=targetKey;data.UserTier=userTier;data.ContentPolicyActionType=action;this.GetContentPolicyAction=data}};SetContentPolicyAction=Class();SetContentPolicyAction.prototype={initialize:function(targetKey,userTier,action,policy){var data=new Object();data.TargetKey=targetKey;data.UserTier=userTier;data.ContentPolicyActionType=action;data.ContentPolicy=policy;this.SetContentPolicyAction=data}};ContentPolicy=Class();
ContentPolicy.prototype={initialize:function(name){var data=new Object();data.Name=name;this.ContentPolicy=data}};ContentPolicyActionType=Class();ContentPolicyActionType.prototype={initialize:function(name){var data=new Object();data.Name=name;this.ContentPolicyActionType=data}};UpdateForumAction=Class();UpdateForumAction.prototype={initialize:function(forumKey,title,description){var data=new Object();data.ForumKey=forumKey;data.Title=title;data.Description=description;this.UpdateForumAction=data}};UpdateForumDiscussionAction=Class();UpdateForumDiscussionAction.prototype={initialize:function(key,title,body,isQuestion){var data=new Object();data.TargetThis=key;data.Title=title;data.Body=body;data.IsQuestion=isQuestion;this.UpdateForumDiscussionAction=data}};UpdateForumPostAction=Class();UpdateForumPostAction.prototype={initialize:function(key,title,body,isQuestion){var data=new Object();data.TargetThis=key;data.Title=title;data.Body=body;data.IsQuestion=isQuestion;this.UpdateForumPostAction=data
}};ForumToggleDiscussionStickyAction=Class();ForumToggleDiscussionStickyAction.prototype={initialize:function(discussionKey){var data=new Object();data.DiscussionKey=discussionKey;this.ForumToggleDiscussionStickyAction=data}};ForumToggleDiscussionClosedAction=Class();ForumToggleDiscussionClosedAction.prototype={initialize:function(discussionKey){var data=new Object();data.DiscussionKey=discussionKey;this.ForumToggleDiscussionClosedAction=data}};ForumDiscussionsPage=Class();ForumDiscussionsPage.prototype={initialize:function(forumKey,numberPerPage,oneBasedOnPage,sort){var data=new Object();data.ForumKey=forumKey;data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.ForumDiscussionsPage=data}};ForumPostsPage=Class();ForumPostsPage.prototype={initialize:function(forumDiscussionKey,numberPerPage,oneBasedOnPage,sort){var data=new Object();data.DiscussionKey=forumDiscussionKey;data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.ForumPostsPage=data
}};ForumsPage=Class();ForumsPage.prototype={initialize:function(numberPerPage,oneBasedOnPage,sort){var data=new Object();data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.ForumsPage=data}};CommunityGroupPage=Class();CommunityGroupPage.prototype={initialize:function(numberPerPage,oneBasedOnPage,sort){var data=new Object();data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.CommunityGroupPage=data}};CommunityGroupMembership=Class();CommunityGroupMembership.prototype={initialize:function(groupKey,userKey){var data=new Object();data.CommunityGroupKey=groupKey;data.UserKey=userKey;this.CommunityGroupMembership=data}};CommunityGroupMembershipPage=Class();CommunityGroupMembershipPage.prototype={initialize:function(key,numberPerPage,oneBasedOnPage,sort,membershipFilter){var data=new Object();data.Key=key;data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;data.MembershipFilter=membershipFilter;this.CommunityGroupMembershipPage=data
}};CommunityGroupRegistrantPage=Class();CommunityGroupRegistrantPage.prototype={initialize:function(key,numberPerPage,oneBasedOnPage,sort){var data=new Object();data.CommunityGroupKey=key;data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.CommunityGroupRegistrantPage=data}};CommunityGroupBannedUserPage=Class();CommunityGroupBannedUserPage.prototype={initialize:function(key,numberPerPage,oneBasedOnPage,sort){var data=new Object();data.CommunityGroupKey=key;data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.CommunityGroupBannedUserPage=data}};CommunityGroupInvitedUserPage=Class();CommunityGroupInvitedUserPage.prototype={initialize:function(key,numberPerPage,oneBasedOnPage,sort){var data=new Object();data.CommunityGroupKey=key;data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.CommunityGroupInvitedUserPage=data}};UpdateCommunityGroupAction=Class();UpdateCommunityGroupAction.prototype={initialize:function(key,title,description,categories,visibility,bookmarks,section,photoKey){var data=new Object();
data.CommunityGroupKey=key;data.Title=title;data.Description=description;data.Categories=categories;data.Visibility=visibility,data.Bookmarks=bookmarks;data.Section=section;data.PhotoKey=photoKey;this.UpdateCommunityGroupAction=data}};UpdateCommunityGroupBookmarksAction=Class();UpdateCommunityGroupBookmarksAction.prototype={initialize:function(key,bookmarks){var data=new Object();data.CommunityGroupKey=key;data.Bookmarks=bookmarks;this.UpdateCommunityGroupBookmarksAction=data}};UpdateCommunityGroupMembershipAction=Class();UpdateCommunityGroupMembershipAction.prototype={initialize:function(communityGroupKey,userKey,membershipTier,isBanned,banMessage){var data=new Object();data.CommunityGroupKey=communityGroupKey;data.UserKey=userKey;data.MembershipTier=membershipTier;data.IsBanned=isBanned;data.BanMessage=banMessage;this.UpdateCommunityGroupMembershipAction=data}};RequestCommunityGroupMembershipAction=Class();RequestCommunityGroupMembershipAction.prototype={initialize:function(communityGroupKey,userKey,message){var data=new Object();
data.CommunityGroupKey=communityGroupKey;data.UserKey=userKey;data.Message=message;this.RequestCommunityGroupMembershipAction=data}};EventsPage=Class();EventsPage.prototype={initialize:function(eventSetKey,startDate,endDate,numberPerPage,oneBasedOnPage,sort){var data=new Object();data.EventSetKey=eventSetKey;data.StartDate=startDate;data.EndDate=endDate;data.NumberPerPage=numberPerPage;data.OnPage=oneBasedOnPage;data.Sort=sort;this.EventsPage=data}};UpdateEventAction=Class();UpdateEventAction.prototype={initialize:function(key,title,description,location,bookmarkName,bookmarkUrl,startDate,endDate,utcOffset){var data=new Object();data.TargetThis=key;data.Title=title;data.Description=description;data.Location=location;data.BookmarkName=bookmarkName;data.BookmarkUrl=bookmarkUrl;data.StartDate=startDate;data.EndDate=endDate;data.UtcOffset=utcOffset;this.UpdateEventAction=data}};RecentMiniFeedActivity=Class();RecentMiniFeedActivity.prototype={initialize:function(communityGroupKey,onPage,numberPerPage){var data=new Object();
data.CommunityGroupKey=communityGroupKey;data.OnPage=onPage;data.NumberPerPage=numberPerPage;this.RecentMiniFeedActivity=data}};CommunityGroupMostActiveMembers=Class();CommunityGroupMostActiveMembers.prototype={initialize:function(communityGroupKey,age,maximumNumberOfMembers){var data=new Object();data.CommunityGroupKey=communityGroupKey;data.Age=age;data.MaximumNumberOfMembers=maximumNumberOfMembers;this.CommunityGroupMostActiveMembers=data}};CommunityGroupSearchAction=Class();CommunityGroupSearchAction.prototype={initialize:function(communityGroupKey,searchType,searchString,numberPerPage,onPage){var data=new Object();data.CommunityGroupKey=communityGroupKey;data.SearchType=searchType;data.SearchString=searchString;data.OnPage=onPage;data.NumberPerPage=numberPerPage;this.CommunityGroupSearchAction=data}};RequestDeleteCommunityGroupAction=Class();RequestDeleteCommunityGroupAction.prototype={initialize:function(communityGroupKey,deleteReason){var data=new Object();data.CommunityGroupKey=communityGroupKey;
data.DeleteReason=deleteReason;this.RequestDeleteCommunityGroupAction=data}};CommunityGroupRecentForumDiscussions=Class();CommunityGroupRecentForumDiscussions.prototype={initialize:function(communityGroupKey,age,maximumNumberOfDiscussions){var data=new Object();data.CommunityGroupKey=communityGroupKey;data.Age=age;data.MaximumNumberOfDiscussions=maximumNumberOfDiscussions;this.CommunityGroupRecentForumDiscussions=data}};SystemTimeInfo=Class();SystemTimeInfo.prototype={initialize:function(){var data=new Object();this.SystemTimeInfo=data}}})();ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.CharCounter=function(maxChars){var labelSetter;var charGetter;var charSetter;var ensureCharsWithinLimit=function(){var chars=charGetter();if(chars.length>maxChars){charSetter(chars.substring(0,maxChars))}};this.configure=function(_labelSetter,_charGetter,_charSetter){labelSetter=_labelSetter;charGetter=_charGetter;charSetter=_charSetter;this.count()};this.count=function(){ensureCharsWithinLimit();
var charsLeft=maxChars-charGetter().length;labelSetter(charsLeft)};this.reset=function(){labelSetter(maxChars);charSetter("")}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.CommentConverter=function(){this.convert=function(inputString){inputString=removeHtmlLineBreaks(inputString);inputString=removeExtraEnvelopingWhiteSpace(inputString);inputString=ensureLineBreaksBeforeAndAfterBlockQuotes(inputString);inputString=removeLeadingAndTrailingCarriageReturns(inputString);inputString=replaceDoubleLineBreaksWithHtmlParagraphTags(inputString);inputString=replaceSingleLineBreaksWithBrTags(inputString);inputString=removeParagraphTagsBeforeAndAfterBlockQuotes(inputString);inputString=wrapUrlsInATags(inputString);inputString=escapeAllInvalidTags(inputString);return inputString};function removeHtmlLineBreaks(inputString){inputString=inputString.replace(/<\/?(br|BR)(\s.*?|\s*)\/?\s*>/g,"\n");inputString=inputString.replace(/<\/?(p|P)(\s.*?|\s*)\/?\s*>/g,"\n\n");return inputString
}function removeExtraEnvelopingWhiteSpace(inputString){return inputString.replace(/\s$|^\s/g,"")}function ensureLineBreaksBeforeAndAfterBlockQuotes(inputString){inputString=inputString.replace(/[\s\n]*(<\/\s*blockquote\s*>)[\s\n]*/g,"\n\n$1\n\n");inputString=inputString.replace(/[\s\n]*(<\s*blockquote\s*>)[\s\n]*/g,"\n\n$1\n\n");return inputString}function removeParagraphTagsBeforeAndAfterBlockQuotes(inputString){inputString=inputString.replace(/<p>(<\/\s*blockquote\s*>)<\/p>/g,"$1");inputString=inputString.replace(/<p>(<\s*blockquote\s*>)<\/p>/g,"$1");return inputString}function removeLeadingAndTrailingCarriageReturns(inputString){return inputString.replace(/\n*$|^\n*/g,"")}function replaceDoubleLineBreaksWithHtmlParagraphTags(inputString){inputString=inputString.replace(/\s*\n\s*\n\s*/g,"</p><p>");return"<p>"+inputString+"</p>"}function replaceSingleLineBreaksWithBrTags(inputString){return inputString.replace(/\s*\n\s*/g,"<br/>")}function escapeAllInvalidTags(inputString){inputString=inputString.replace(/<(\/)?([pbi]|blockquote|a( href=['"][^<>]*['"])?)>/g,"[===$1$2===]");
inputString=inputString.replace(/<br\s*\/>/g,"{===br===/}");inputString=escapeAngleBrackets(inputString);inputString=inputString.replace(/\{===br===\/\}/g,"<br/>");inputString=inputString.replace(/\[===(\/)?([pbi]|blockquote|a( href=.*?)?)===\]/g,"<$1$2>");return inputString}function escapeAngleBrackets(inputString){return inputString.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u201D/g,"").replace(/\u201C/g,"").replace(/\u2019/g,"")}function wrapUrlsInATags(inputString){return inputString.replace(/([^='"])(http:\/\/[^<\s]+)/g,"$1<a href='$2'>$2</a>")}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.CommentPopupWindowController=function(popupView){function onLoad(){popupView.registerClickListeners(openWindow);popupView.registerRefreshClickListener()}function openWindow(event){popupView.openNewWindow(event)}popupView.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.CommentPopupWindowView=function(popupView){this.registerClickListeners=function(callback){jQ("#pluck-container .popup-comments").click(callback)
};this.registerRefreshClickListener=function(){var refreshPopup=function(){try{window.location.reload(true)}catch(e){}};jQ("#popup-header input.refresh-button").click(refreshPopup)};this.addLoadEvent=function(callback){jQ(document).ready(callback)};this.openNewWindow=function(event){var url=getAncestorOfType(guardian.r2.event.getElement(event),"a").href;var popupWidth=470;var leftPos=calculateXForCentredPopup(popupWidth);window.open(url,"popupCommentsWindow","resizable=yes,scrollbars=yes,location=yes,toolbar=yes,status=no,top=0,screenY=0,left="+leftPos+",screenX="+leftPos+",height=690,width="+popupWidth);guardian.r2.event.stop(event)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.CommentSliceStream=function(commentService,articleService,articleId){this.length=function(callback){articleService.getArticleSummaries([articleId],function(articleSummaryArray){var numberOfCommentsForArticle=parseInt(articleSummaryArray[0].numberOfComments,10);var numberOfSlices=Math.ceil(numberOfCommentsForArticle/10);
callback(numberOfSlices)})};this.get=function(commentSliceNumber,callback){commentService.getCommentsForSlice(articleId,commentSliceNumber,commentService.TIME_ASCENDING_ORDER,callback)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.ErrorMessageView=function(){function objectToString(exception){if(typeof exception==="object"){var result=["{"];for(var name in exception){if(exception.hasOwnProperty(name)){result.push(name+" -> ");result.push(objectToString(exception[name]))}}result.push("}");return result.join("\n")}return exception.toString()}this.writeMessage=function(exception){var div=document.createElement("textarea");div.style.display="none";div.style.width="100%";div.style.height="400px";div.innerHTML=objectToString(exception);document.getElementsByTagName("body")[0].appendChild(div)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.FeaturedCommentModifier=function(authenticationService,userProfileService,featuredCommentsService,sectionName){this.modify=function(commentData,callback){if(!authenticationService.isUserLoggedIntoPluck()){callback(commentData)
}else{var userProfileCallback=function(loggedInUserInfo){if(!loggedInUserInfo.hasCapability("featureComment")){callback(commentData)}else{var featuredCommentsCallback=function(featuredCommentKeys){for(var i=0;i<commentData.Comments.length;++i){if(arrayIndexOf(featuredCommentKeys,commentData.Comments[i].CommentKey.Key)!==-1){commentData.Comments[i].IsFeatured=true}else{commentData.Comments[i].IsFeatured=false}}callback(commentData)};featuredCommentsService.getComments(sectionName,featuredCommentsCallback)}};userProfileService.getUserProfile(authenticationService.getLoggedInUserId(),userProfileCallback)}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.FeaturedCommentsController=function(service,view,sectionName,loggedInUserId,userProfileService){var instance=this;function refreshFeaturedComments(){view.refresh()}this.feature=function(commentId){service.feature(commentId,sectionName,refreshFeaturedComments)};this.unfeature=function(commentId){service.unfeature(commentId,sectionName,refreshFeaturedComments)
};var internalCallback=function(loggedInUserInfo){if(loggedInUserInfo.hasCapability("featureComment")){view.registerClickListenerOnFeatureButton(instance.feature);view.registerClickListenerOnUnfeatureButton(instance.unfeature)}};if(loggedInUserId){userProfileService.getUserProfile(loggedInUserId,internalCallback)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.FeaturedCommentsService=function(pluckObjectFactory,pluckSender){function convertFromArrayToString(theArray){var theString="";for(var i=0;i<theArray.length;i++){theString+='"'+theArray[i]+'"';if(i<theArray.length-1){theString+=","}}return"["+theString+"]"}function convertFromStringToArray(theString){if(theString==="[]"){return[]}return theString.replace(/(\[|\]|\")/g,"").split(",")}this.getComments=function(sectionName,getCommentsCallback){var internalCallback=function(responseBatch){getCommentsCallback(convertFromStringToArray(responseBatch.Responses[0].CustomItem.Content))};var key=pluckObjectFactory.newCustomItemKey(generateKey(sectionName));
internalCallback.errorHandler=function(error){if(error.messages.length>0&&error.messages[0].indexOf("Unable to find data on request:[CustomItemRequest]")!==-1){getCommentsCallback([])}};pluckSender.submit(internalCallback,key)};this.feature=function(commentId,sectionName,callback){var internalCallback=function(commentIds){if(!arrayContains(commentIds,commentId)){if(commentIds.length>49){commentIds=commentIds.slice(1)}commentIds.push(commentId)}submitCustomItemAction(sectionName,commentIds,callback)};this.getComments(sectionName,internalCallback)};this.unfeature=function(commentId,sectionName,callback){var internalCallback=function(commentIds){var index=arrayIndexOf(commentIds,commentId);commentIds.splice(index,1);submitCustomItemAction(sectionName,commentIds,callback)};this.getComments(sectionName,internalCallback)};function submitCustomItemAction(sectionName,commentIds,callback){var customItemKey=pluckObjectFactory.newCustomItemKey(generateKey(sectionName));var customItemAction=pluckObjectFactory.newUpdateCustomItemAction(customItemKey,convertFromArrayToString(commentIds));
pluckSender.submit(callback,customItemAction)}function generateKey(sectionName){return"SectionName:"+sectionName}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.FeaturedCommentsView=function(){this.registerClickListenerOnFeatureButton=function(callback){registerClickListenerOnButton(callback,"feature")};this.registerClickListenerOnUnfeatureButton=function(callback){registerClickListenerOnButton(callback,"unfeature")};this.refresh=function(){window.location.reload()};function registerClickListenerOnButton(callback,className){var myCallback=function(event){var target=guardian.r2.event.getElement(event);if(target.className===className){var commentKey=target.parentNode.parentNode.id;callback(commentKey)}};addEvent("pluck-comments","click",myCallback);addEvent("pluck-addressed-comment","click",myCallback)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.MostRecommendedController=function(discoverArticlesService,commentService,mostRecommendedView,tagId){var instance=this;
function onLoad(){var discoverArticlesCallback=function(discovererdArticles){var sortByMostRecommended=function(articleOne,articleTwo){return articleTwo.numberOfRecommendations-articleOne.numberOfRecommendations};discovererdArticles.sort(sortByMostRecommended);mostRecommendedView.renderArticles(discovererdArticles)};discoverArticlesService.findMostRecommendedArticlesByTagForLast24Hours(tagId,discoverArticlesCallback);registerViewListeners()}function registerViewListeners(){mostRecommendedView.registerClickListenerOnShowArticleCommentsButton(instance.showArticleComments);mostRecommendedView.registerClickListenerOnCloseArticleCommentsButton(instance.closeArticleComments)}this.showArticleComments=function(articleId,numberOfArticleComments,articleUrl){commentService.setNumberOfCommentsPerPage(numberOfArticleComments);var articleCommentsCallback=function(articleComments){var sortByMostRecommendedComments=function(commentOne,commentTwo){return commentTwo.NumberOfRecommendations-commentOne.NumberOfRecommendations
};var comments=articleComments.Comments;comments.sort(sortByMostRecommendedComments);mostRecommendedView.renderArticleComments(articleId,comments.slice(0,10),articleUrl)};var pageNumber=1;commentService.getComments(articleId,pageNumber,commentService.TIME_ASCENDING_ORDER,articleCommentsCallback)};this.closeArticleComments=function(articleId){mostRecommendedView.closeArticleComments(articleId)};mostRecommendedView.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.MostRecommendedView=function(templateRenderer){this.addLoadEvent=function(callback){addSafeLoadEvent(callback)};this.registerClickListenerOnShowArticleCommentsButton=function(callback){var myCallback=function(event){var target=guardian.r2.event.getElement(event);if(target.className==="show-article-comments"){var parentNode=target.parentNode;while(parentNode.className!=="article"){parentNode=parentNode.parentNode}var childNodes=parentNode.childNodes;var articleId,numberOfComments,articleUrl;
var forEachChildNodeCallback=function(childNode){if(childNode.nodeType===1){if(childNode.name==="articleId"){articleId=childNode.value}else{if(childNode.name==="numberOfComments"){numberOfComments=childNode.value}else{if(childNode.name==="articleUrl"){articleUrl=childNode.value}}}}};forEachElementOf(childNodes,forEachChildNodeCallback);var comments=document.getElementById("article-comments-"+articleId);if(comments.hasChildNodes()){showComments(articleId)}else{callback(articleId,numberOfComments,articleUrl)}}};addEvent("articles","click",myCallback)};function showComments(articleId){document.getElementById("article-comments-"+articleId).style.display="block";document.getElementById("show-article-comments-button-"+articleId).style.display="none";document.getElementById("close-article-comments-button-"+articleId).style.display="inline"}this.registerClickListenerOnCloseArticleCommentsButton=function(callback){var myCallback=function(event){var target=guardian.r2.event.getElement(event);if(target.className==="close-article-comments"){var parentNode=target.parentNode;
while(parentNode.className!=="article"){parentNode=parentNode.parentNode}var childNodes=parentNode.childNodes;var articleId;var forEachChildNodeCallback=function(childNode){if(childNode.nodeType===1){if(childNode.name==="articleId"){articleId=childNode.value}}};forEachElementOf(childNodes,forEachChildNodeCallback);callback(articleId)}};addEvent("articles","click",myCallback)};this.renderArticles=function(articles){var targetElement=document.getElementById("articles");var templateElementName="pluck-articles-template";var articleObject={articles:articles};templateRenderer.renderTemplate(targetElement,templateElementName,articleObject)};this.renderArticleComments=function(articleId,articleComments,articleUrl){var targetElement=document.getElementById("article-comments-"+articleId);var templateElementName="pluck-article-comments-template";var articleCommentsObject={comments:articleComments,articleUrl:articleUrl};templateRenderer.renderTemplate(targetElement,templateElementName,articleCommentsObject);
showComments(articleId)};this.closeArticleComments=function(articleId){document.getElementById("article-comments-"+articleId).style.display="none";document.getElementById("show-article-comments-button-"+articleId).style.display="inline";document.getElementById("close-article-comments-button-"+articleId).style.display="none"}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.Paginator=function(numberOfCommentsPerPage){var getPageNumbers=function(currentPageNumber,totalNumberOfPages){var crumbs=7;var crumbsAfter=3;var crumbsBefore=3;while(currentPageNumber+crumbsAfter>totalNumberOfPages&&crumbsAfter>0){crumbsAfter--;crumbsBefore++}while(currentPageNumber-crumbsBefore<=0){crumbsBefore--}var pageNumbers=[];for(var pageNumber=currentPageNumber-crumbsBefore;pageNumbers.length<crumbs&&pageNumber<=totalNumberOfPages;pageNumber++){pageNumbers.push(pageNumber)}return pageNumbers};this.render=function(currentPageNumber,totalNumberOfComments,urlParams,renderFunction){var totalNumberOfPages=parseInt(totalNumberOfComments,10)===0?1:Math.ceil(totalNumberOfComments/numberOfCommentsPerPage);
var pageNumbers=getPageNumbers(currentPageNumber,totalNumberOfPages);var prev=currentPageNumber-1<1?null:currentPageNumber-1;var next=currentPageNumber+1>totalNumberOfPages?null:currentPageNumber+1;var first=pageNumbers[0]===1?null:1;var last=pageNumbers[pageNumbers.length-1]===totalNumberOfPages?null:totalNumberOfPages;if(pageNumbers.length>1){var startSlice=currentPageNumber*numberOfCommentsPerPage-numberOfCommentsPerPage+1;var endSlice=currentPageNumber*numberOfCommentsPerPage>totalNumberOfComments?totalNumberOfComments:currentPageNumber*numberOfCommentsPerPage;var paginationInfo={currentPageNumber:currentPageNumber,pageNumbers:pageNumbers,first:first,last:last,prev:prev,next:next,urlParams:urlParams,currentSliceInformation:startSlice+" - "+endSlice};renderFunction(paginationInfo)}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckAbuseBoxController=function(authenticationService,reportAbuseService,reportAbuseView,charCounter){var instance=this;var commentKey;
var errorHasOccured=false;function onLoad(){charCounter.configure(reportAbuseView.setCharsLeft,reportAbuseView.getRawAbuseDescription,reportAbuseView.setAbuseDescription);registerViewListeners();reportAbuseView.init()}function resetAbuseBox(){charCounter.reset();resetView()}function registerViewListeners(){reportAbuseView.registerClickListenerOnOpenAbuseBoxButton(instance.openAbuseBox);reportAbuseView.registerClickListenerOnCloseConfirmButton(instance.closeConfirm);reportAbuseView.registerClickListenerOnSubmitAbuseReportButton(instance.submitAbuseReport);reportAbuseView.registerClickListenerOnCloseAbuseBoxButton(instance.closeAbuseBox);reportAbuseView.registerClickListenerOnCancelCloseButton(instance.cancelClose);reportAbuseView.registerChangeListenerOnAbuseReasonList(instance.changeAbuseReason);reportAbuseView.registerChangeListenerOnAbuseReasonList(instance.validate);reportAbuseView.registerKeyPressListenerOnAbuseEmail(instance.validate);reportAbuseView.registerKeyPressListenerOnAbuseDescriptionTextArea(instance.validate);
reportAbuseView.registerKeyPressListenerOnAbuseDescriptionTextArea(charCounter.count)}function isDirty(){return reportAbuseView.getAbuseReason()!==""||reportAbuseView.getRawAbuseDescription()!==""||reportAbuseView.getAbuseEmail()!==""}function isValid(){return isAbuseReasonSelected()&&isEmailValid()&&isAbuseDescriptionValid()}function isAbuseReasonSelected(){return reportAbuseView.getAbuseReason()!==""}function isAbuseDescriptionValid(){if(reportAbuseView.getAbuseReason()!=="Other"){return true}else{return trim(reportAbuseView.getRawAbuseDescription()).length>0}}function processResponse(){showThankYouArea();reportAbuseView.disableOpenAbuseBoxButton(commentKey)}function handleError(){errorHasOccured=true;reportAbuseView.hideProgressArea();reportAbuseView.showPluckErrorArea()}function isEmailValid(){var valid=false;var email=trim(reportAbuseView.getAbuseEmail());var filter=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;return email.length===0||filter.test(email)}function resetView(){reportAbuseView.hideEmailInfo();
reportAbuseView.hideLoginInfo();reportAbuseView.hideProgressArea();reportAbuseView.hideCloseConfirmationArea();reportAbuseView.hideThankYouArea();reportAbuseView.hidePluckErrorArea();reportAbuseView.disableSubmitButton();reportAbuseView.resetAbuseReason();reportAbuseView.clearAbuseDescription();reportAbuseView.clearAbuseEmail();reportAbuseView.setAbuseDescriptionOptional();reportAbuseView.showEditArea();reportAbuseView.showCloseButton()}function showProgressArea(){reportAbuseView.hideEditArea();reportAbuseView.showProgressArea()}function showEditArea(){reportAbuseView.hideCloseConfirmationArea();reportAbuseView.showCloseButton();reportAbuseView.showEditArea()}function showCloseConfirmationArea(){reportAbuseView.hideCloseButton();reportAbuseView.hideEditArea();reportAbuseView.showCloseConfirmationArea()}function showThankYouArea(){reportAbuseView.hideProgressArea();reportAbuseView.hideCloseButton();reportAbuseView.showThankYouArea()}this.openAbuseBox=function(_commentKey){commentKey=_commentKey;
resetAbuseBox();if(authenticationService.isUserLoggedIntoPluck()){reportAbuseView.setUserName(authenticationService.getLoggedInUserName());reportAbuseView.showLoginInfo()}else{reportAbuseView.showEmailInfo()}reportAbuseView.showAbuseBox()};this.closeAbuseBox=function(){if(!isDirty()||errorHasOccured){instance.closeConfirm();return }showCloseConfirmationArea()};this.closeConfirm=function(){reportAbuseView.hideAbuseBox()};this.cancelClose=function(){showEditArea()};this.submitAbuseReport=function(){showProgressArea();var abuseReport={commentKey:commentKey,reason:reportAbuseView.getAbuseReason(),description:reportAbuseView.getAbuseDescription(),email:reportAbuseView.getAbuseEmail()};var callback=processResponse;callback.errorHandler=handleError;reportAbuseService.reportAbuse(abuseReport,callback)};this.changeAbuseReason=function(){if(reportAbuseView.getAbuseReason()==="Other"){reportAbuseView.setAbuseDescriptionMandatory()}else{reportAbuseView.setAbuseDescriptionOptional()}};this.validate=function(){if(isValid()){reportAbuseView.enableSubmitButton()
}else{reportAbuseView.disableSubmitButton()}};reportAbuseView.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckAbuseBoxView=function(){var dialogBox=new guardian.r2.DialogBox();function positionAbuseBox(){var abuseBox=document.getElementById("abuse-box");var abuseBoxWrapper=document.getElementById("abuse-box-wrapper");dialogBox.positionDialogBox(abuseBox,abuseBoxWrapper)}this.addLoadEvent=function(callback){addEvent(document,"load",callback)};this.registerClickListenerOnCloseAbuseBoxButton=function(callback){addEvent("abuse-box-close","click",callback)};this.registerClickListenerOnCloseConfirmButton=function(callback){addEvent("abuse-close-confirm","click",callback);addEvent("abuse-close-thank-you","click",callback)};this.registerClickListenerOnSubmitAbuseReportButton=function(callback){addEvent("abuse-submit","click",callback)};this.registerClickListenerOnCancelCloseButton=function(callback){addEvent("abuse-close-cancel","click",callback)
};this.registerChangeListenerOnAbuseReasonList=function(callback){addEvent("abuse-reason","change",callback)};this.registerKeyPressListenerOnAbuseEmail=function(callback){addEvent("abuse-email","keyup",callback)};this.registerKeyPressListenerOnAbuseDescriptionTextArea=function(callback){addEvent("abuse-description","keyup",callback)};this.showAbuseBox=function(){var abuseBox=document.getElementById("abuse-box");var abuseBoxWrapper=document.getElementById("abuse-box-wrapper");dialogBox.showDialogBox(abuseBox,abuseBoxWrapper)};this.hideAbuseBox=function(){abuseBoxWrapper=document.getElementById("abuse-box-wrapper");abuseBoxWrapper.style.display="none";dialogBox.hideDialogBox(abuseBoxWrapper)};this.setUserName=function(userName){document.getElementById("abuse-user-name").innerHTML=userName};this.showEmailInfo=function(){document.getElementById("abuse-email-info").style.display="block"};this.hideEmailInfo=function(){document.getElementById("abuse-email-info").style.display="none"};this.showLoginInfo=function(){document.getElementById("abuse-login-info").style.display="block"
};this.hideLoginInfo=function(){document.getElementById("abuse-login-info").style.display="none"};this.getAbuseReason=function(){return document.getElementById("abuse-reason").value};this.resetAbuseReason=function(){setTimeout(function(){document.getElementById("abuse-reason").value=""},0)};this.getAbuseDescription=function(){return document.getElementById("abuse-description").value};this.getRawAbuseDescription=function(){return document.getElementById("abuse-description").value};this.setAbuseDescription=function(abuseDescription){document.getElementById("abuse-description").value=abuseDescription};this.clearAbuseDescription=function(){document.getElementById("abuse-description").value=""};this.setAbuseDescriptionOptional=function(){document.getElementById("abuse-description-optional").style.display="inline"};this.setAbuseDescriptionMandatory=function(){document.getElementById("abuse-description-optional").style.display="none"};this.getAbuseEmail=function(){return document.getElementById("abuse-email").value
};this.clearAbuseEmail=function(){document.getElementById("abuse-email").value=""};this.showEditArea=function(){document.getElementById("abuse-box-edit-area").style.display="block"};this.hideEditArea=function(){document.getElementById("abuse-box-edit-area").style.display="none"};this.showProgressArea=function(){document.getElementById("abuse-progress-area").style.display="block"};this.hideProgressArea=function(){document.getElementById("abuse-progress-area").style.display="none"};this.showThankYouArea=function(){document.getElementById("abuse-thank-you-area").style.display="block"};this.hideThankYouArea=function(){document.getElementById("abuse-thank-you-area").style.display="none"};this.showCloseConfirmationArea=function(){document.getElementById("abuse-close-confirmation-area").style.display="block"};this.hideCloseConfirmationArea=function(){document.getElementById("abuse-close-confirmation-area").style.display="none"};this.showCloseButton=function(){document.getElementById("abuse-box-close").style.display="block"
};this.hideCloseButton=function(){document.getElementById("abuse-box-close").style.display="none"};this.disableOpenAbuseBoxButton=function(commentKey){var commentUl=document.getElementById(commentKey);guardian.r2.dom.element.getElementsByCssSelector(".abuse-report",commentUl)[0].innerHTML="Report abuse"};this.disableSubmitButton=function(){document.getElementById("abuse-submit").disabled=true};this.enableSubmitButton=function(){document.getElementById("abuse-submit").disabled=false};this.setCharsLeft=function(charsLeft){document.getElementById("abuse-chars-left").innerHTML=charsLeft};this.showPluckErrorArea=function(){document.getElementById("abuse-pluck-error-area").style.display="block"};this.hidePluckErrorArea=function(){document.getElementById("abuse-pluck-error-area").style.display="none"};this.init=function(){}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckAnnotationService=function(pluckObjectFactory,pluckSender){this.saveAnnotation=function(userId,clippingId,annotationContent){var key=pluckObjectFactory.newCustomItemKey(buildKey(clippingId,userId));
if(trim(annotationContent)===""){annotationContent="DELETED"}var updateCustomItemAction=pluckObjectFactory.newUpdateCustomItemAction(key,annotationContent);var ignoreCallback=function(){};pluckSender.submit(ignoreCallback,updateCustomItemAction)};this.getAnnotations=function(userId,clippingIds,callback){var internalCallback=function(responseBatch){var customItems=[];for(var i=0;i<responseBatch.Responses.length;i++){customItems.push(responseBatch.Responses[i].CustomItem)}callback(customItems)};internalCallback.errorHandler=function(errors){internalCallback(errors.responseBatch)};var args=[internalCallback];for(var i=0;i<clippingIds.length;++i){args.push(pluckObjectFactory.newCustomItemKey(buildKey(clippingIds[i],userId)))}pluckSender.submit.apply(pluckSender,args)};function buildKey(clippingId,userId){return"ClippingId:"+clippingId+",UserId:"+userId}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckApplicationContext=function(serverData){var instance=this;var config={messages:{commentBlocked:"This comment has been removed by a moderator. Replies may also be deleted."},commentsSignUpUrl:serverData.env.commentsSignUpUrl,numberOfCommentsPerPage:50,signOutUrl:"/Users/signout/tr/1,,,00.html",staticRoot:serverData.env.staticRoot,pluckMaxNumberPerPage:10,addClippingsUrl:serverData.env.addClippingsUrl,commentCountsServiceUrl:serverData.env.commentCountsServiceUrl,discussionCommentCountsServiceUrl:serverData.env.discussionCommentCountsServiceUrl,commentKeyPrefix:"CommentKey:",userProfileServiceUrl:serverData.env.userProfileServiceUrl};
var pluckEvents=new guardian.r2.serverSidePluck.PluckEvents();var pluckObjectFactory=new guardian.r2.serverSidePluck.PluckObjectFactory(config);var errorMessageView=new guardian.r2.serverSidePluck.ErrorMessageView();var pluckSender=new guardian.r2.serverSidePluck.PluckSender(pluckObjectFactory,serverUrl,errorMessageView);var pluckCookieHandler=new guardian.r2.serverSidePluck.PluckHashCookieHandler();var urlStack=new UrlStack(serverData.env.cookieDomain);var authenticationService=new guardian.r2.serverSidePluck.PluckAuthenticationService(config,pluckCookieHandler,urlStack,false);var articleService=new guardian.r2.serverSidePluck.PluckArticleService(pluckObjectFactory,pluckSender);var commentCountService=new guardian.r2.serverSidePluck.PluckCommentCountService(config);var templateRenderer=new guardian.r2.serverSidePluck.TemplateRenderer(config,guardian.r2.DateUtil,serverData.articleInfo,serverData.profilePageUser,serverData.env.pageId);var chalkboardTemplateRenderer=new guardian.r2.serverSidePluck.TemplateRenderer(config,guardian.r2.DateUtil,serverData.chalkboardInfo,serverData.profilePageUser,serverData.env.pageId);
var pluckCommentService=new guardian.r2.serverSidePluck.PluckCommentService(pluckObjectFactory,pluckSender,config);var reportAbuseService=new guardian.r2.serverSidePluck.PluckReportAbuseService(pluckObjectFactory,pluckSender);var abuseBoxCharCounter=new guardian.r2.serverSidePluck.CharCounter(300);var profileDataHelper=new guardian.r2.serverSidePluck.ProfileDataHelper();var userCommentService=new guardian.r2.serverSidePluck.PluckUserCommentService(pluckObjectFactory,pluckSender,serverData.profilePageUser,config);this.buildControllers=function(pluckControllers){pluckControllers=pluckControllers.split(",");for(i=0;i<pluckControllers.length;i++){pluckControllers[i]=pluckControllers[i].replace(/\s/g,"");instance["create"+pluckControllers[i]]()}};this.createPluckUsersReviewController=function(){var pluckUsersReviewView=new guardian.r2.serverSidePluck.PluckUsersReviewView(serverData.filmInfo.filmKey);return new guardian.r2.serverSidePluck.PluckUsersReviewController(pluckUsersReviewView,authenticationService)
};this.createPluckUserAbuseBoxController=function(){var reportAbuseView=new guardian.r2.serverSidePluck.PluckUserAbuseBoxView();return new guardian.r2.serverSidePluck.PluckAbuseBoxController(authenticationService,reportAbuseService,reportAbuseView,abuseBoxCharCounter)};this.createPluckUserClippingsAbuseBoxController=function(){var reportAbuseView=new guardian.r2.serverSidePluck.PluckUserClippingsAbuseBoxView();return new guardian.r2.serverSidePluck.PluckAbuseBoxController(authenticationService,reportAbuseService,reportAbuseView,abuseBoxCharCounter)};this.createPluckCommentAbuseBoxController=function(){if(typeof (sspSitesProxies)==="undefined"){var reportAbuseView=new guardian.r2.serverSidePluck.PluckCommentAbuseBoxView();return new guardian.r2.serverSidePluck.PluckAbuseBoxController(authenticationService,reportAbuseService,reportAbuseView,abuseBoxCharCounter)}};this.createPluckUserProfileAbuseBoxController=function(){var reportAbuseView=new guardian.r2.serverSidePluck.PluckUserProfileAbuseBoxView();
return new guardian.r2.serverSidePluck.PluckAbuseBoxController(authenticationService,reportAbuseService,reportAbuseView,abuseBoxCharCounter)};this.createPluckClippingController=function(){var annotationService=new guardian.r2.serverSidePluck.PluckAnnotationService(pluckObjectFactory,pluckSender);var clippingView=new guardian.r2.serverSidePluck.PluckClippingView(config);var editAnnotationCharCounter=new guardian.r2.serverSidePluck.CharCounter(160);return new guardian.r2.serverSidePluck.PluckClippingController(pluckCommentService,annotationService,clippingView,editAnnotationCharCounter)};this.setupGenericPluckCommentController=function(contentInfo,templateRenderer){var templateName="pluck-comments-template";var commentView=new guardian.r2.serverSidePluck.PluckCommentView(templateRenderer,serverData.parameters.commentId,config,guardian.r2.signInController,templateName);return new guardian.r2.serverSidePluck.PluckCommentController(commentView)};this.createPluckCommentController=function(){return this.setupGenericPluckCommentController(serverData.articleInfo,templateRenderer)
};this.createPluckChalkboardCommentController=function(){return this.setupGenericPluckCommentController(serverData.chalkboardInfo,chalkboardTemplateRenderer)};this.createPopupPluckCommentController=function(){var numberOfCommentsPerPage=40;var showAllComments=true;var pluckCommentService=new guardian.r2.serverSidePluck.PluckCommentService(pluckObjectFactory,pluckSender,config,articleService);pluckCommentService.setNumberOfCommentsPerPage(numberOfCommentsPerPage);var templateName="popup-pluck-comments-template";var commentView=new guardian.r2.serverSidePluck.PluckCommentView(templateRenderer,serverData.parameters.commentId,config,guardian.r2.signInController,templateName);var userProfileService=new guardian.r2.serverSidePluck.UserProfileService(pluckObjectFactory,config,pluckSender,profileDataHelper);var paginator=new guardian.r2.serverSidePluck.Paginator(numberOfCommentsPerPage);var featuredCommentsService=new guardian.r2.serverSidePluck.FeaturedCommentsService(pluckObjectFactory,pluckSender);
var featuredCommentModifier=new guardian.r2.serverSidePluck.FeaturedCommentModifier(authenticationService,userProfileService,featuredCommentsService,serverData.articleInfo.sectionName);var userInfoCommentModifier=new guardian.r2.serverSidePluck.UserInfoCommentModifier(authenticationService,userProfileService);var commentModifiers=[featuredCommentModifier,userInfoCommentModifier];var isMinuteByMinute=false;var addCommentsAsPosted=true;return new guardian.r2.serverSidePluck.PluckCommentController(serverData.articleInfo,pluckCommentService,commentView,serverData.parameters.commentPage,serverData.env.userProfileUrlPrefix,serverData.parameters.commentId,userProfileService,authenticationService,paginator,serverData.parameters.goToLastComment,showAllComments,featuredCommentsService,serverData.articleInfo.sectionName,isMinuteByMinute,commentModifiers,pluckEvents,addCommentsAsPosted,serverData.parameters.scrollToComments)};this.createPluckCommentBoxController=function(){return this.setupGenericPluckCommentBoxControllerNew()
};this.setupGenericPluckCommentBoxControllerNew=function(){var commentBoxView=new guardian.r2.serverSidePluck.PluckCommentBoxView();var charCounter=new guardian.r2.serverSidePluck.CharCounter(5000);var userProfileService=new guardian.r2.serverSidePluck.UserProfileService(pluckObjectFactory,config,pluckSender,profileDataHelper);return new guardian.r2.serverSidePluck.PluckCommentBoxController(authenticationService,commentBoxView,charCounter,serverData.loggedInUser,userProfileService)};this.createPluckChalkboardCommentBoxController=function(){return this.setupGenericPluckCommentBoxController(serverData.chalkboardInfo)};this.setupGenericPluckCommentBoxController=function(contentInfo){if(isUserLoggedIntoRegPss()){var postCommentService=new guardian.r2.serverSidePluck.PluckPostCommentService(config,pluckObjectFactory,pluckSender);var commentBoxView=new guardian.r2.serverSidePluck.PluckCommentBoxView();var commentBoxCharCounter=new guardian.r2.serverSidePluck.CharCounter(5000);var userProfileService=new guardian.r2.serverSidePluck.UserProfileService(pluckObjectFactory,config,pluckSender,profileDataHelper);
var commentConverter=new guardian.r2.serverSidePluck.CommentConverter();var isMinuteByMinute=false;var openCommunityStandardsLinkInNewWindow=false;return new guardian.r2.serverSidePluck.PluckCommentBoxController(authenticationService,postCommentService,commentBoxView,contentInfo,serverData.parameters.showCommentBox,commentBoxCharCounter,userProfileService,commentConverter,isMinuteByMinute,pluckEvents,openCommunityStandardsLinkInNewWindow)}};this.createPluckChalkboardDescriptionController=function(){var postCommentService=new guardian.r2.serverSidePluck.PluckPostCommentService(config,pluckObjectFactory,pluckSender);var commentBoxView=new guardian.r2.serverSidePluck.PluckChalkboardDescriptionStatusView();var userProfileService=new guardian.r2.serverSidePluck.UserProfileService(pluckObjectFactory,config,pluckSender,profileDataHelper);var commentConverter=new guardian.r2.serverSidePluck.CommentConverter();return new guardian.r2.serverSidePluck.PluckChalkboardDescriptionController(authenticationService,postCommentService,commentBoxView,serverData.chalkboardInfo,userProfileService,commentConverter,pluckEvents,serverData.loggedOnUser,config)
};this.createPopupPluckCommentBoxController=function(){if(isUserLoggedIntoRegPss()){var popupAuthenticationService=new guardian.r2.serverSidePluck.PluckAuthenticationService(config,pluckCookieHandler,urlStack,true);var postCommentService=new guardian.r2.serverSidePluck.PluckPostCommentService(config,pluckObjectFactory,pluckSender);var commentBoxView=new guardian.r2.serverSidePluck.PluckCommentBoxView();var commentBoxCharCounter=new guardian.r2.serverSidePluck.CharCounter(5000);var userProfileService=new guardian.r2.serverSidePluck.UserProfileService(pluckObjectFactory,config,pluckSender,profileDataHelper);var commentConverter=new guardian.r2.serverSidePluck.CommentConverter();var openCommunityStandardsLinkInNewWindow=true;var isMinuteByMinute=true;var showCommentBox=true;return new guardian.r2.serverSidePluck.PluckCommentBoxController(popupAuthenticationService,postCommentService,commentBoxView,serverData.articleInfo,showCommentBox,commentBoxCharCounter,userProfileService,commentConverter,isMinuteByMinute,pluckEvents,openCommunityStandardsLinkInNewWindow)
}};this.createUserProfileController=function(){var userProfileService=new guardian.r2.serverSidePluck.UserProfileService(pluckObjectFactory,config,pluckSender,profileDataHelper);var userProfileView=new guardian.r2.serverSidePluck.UserProfileView(templateRenderer);return new guardian.r2.serverSidePluck.UserProfileController(serverData.profilePageUser,userProfileService,userProfileView,authenticationService,config,serverData.parameters.isEditProfilePage)};this.createPluckRecommendationController=function(){var recommendService=new guardian.r2.serverSidePluck.PluckRecommendationService(pluckObjectFactory,pluckSender);var recommendView=new guardian.r2.serverSidePluck.PluckRecommendationView();return new guardian.r2.serverSidePluck.PluckRecommendationController(recommendService,recommendView)};this.createPluckChalkboardRecommendationController=function(){var recommendService=new guardian.r2.serverSidePluck.PluckRecommendationService(pluckObjectFactory,pluckSender);var recommendView=new guardian.r2.serverSidePluck.PluckRecommendationView();
return new guardian.r2.serverSidePluck.PluckRecommendationController(recommendService,recommendView)};this.createPluckUserCommentController=function(){var numberOfCommentsPerPage=20;var r2CommentDataService=new guardian.r2.serverSidePluck.R2CommentDataService(serverData.env.commentDataUrl,serverData.env.pageId);var userCommentView=new guardian.r2.serverSidePluck.PluckUserCommentView(templateRenderer);var paginator=new guardian.r2.serverSidePluck.Paginator(numberOfCommentsPerPage);var renderer=new guardian.r2.serverSidePluck.PluckUserCommentRenderer(userCommentView,authenticationService,serverData.profilePageUser,profileDataHelper);return new guardian.r2.serverSidePluck.PluckUserCommentController(userCommentService,userCommentView,serverData.parameters.commentPage,paginator,r2CommentDataService,renderer)};this.createPluckUserLatestCommentsController=function(){var view=new guardian.r2.serverSidePluck.PluckUserLatestCommentsView(templateRenderer);var renderer=new guardian.r2.serverSidePluck.PluckUserCommentRenderer(view,authenticationService,serverData.profilePageUser,profileDataHelper);
return new guardian.r2.serverSidePluck.PluckUserLatestCommentsController(userCommentService,view,renderer)};this.createPluckCommentCountController=function(){var commentCountView=new guardian.r2.serverSidePluck.PluckCommentCountView();return new guardian.r2.serverSidePluck.PluckCommentCountController(commentCountService,commentCountView)};this.createPluckCommentCountControllerWithCommentingReportView=function(){var commentCountView=new guardian.r2.serverSidePluck.PluckCommentCountView();return new guardian.r2.serverSidePluck.PluckCommentCountController(commentCountService,commentCountView)};this.createPluckSignInController=function(){var signInView=new guardian.r2.serverSidePluck.SignInView();return new guardian.r2.serverSidePluck.SignInController(authenticationService,signInView)};this.createMostRecommendedController=function(){var mostRecommendedView=new guardian.r2.serverSidePluck.MostRecommendedView(templateRenderer);var discoverArticleService=new guardian.r2.serverSidePluck.PluckDiscoverArticlesService(pluckObjectFactory,pluckSender);
return new guardian.r2.serverSidePluck.MostRecommendedController(discoverArticleService,pluckCommentService,mostRecommendedView,serverData.articleInfo.sectionKeyWordId)};this.createPluckSearchController=function(){var numberOfCommentsPerPage=10;var pluckSearchTermExtractor=new guardian.r2.serverSidePluck.PluckSearchTermExtractor();var searchService=new guardian.r2.serverSidePluck.PluckSearchService(pluckObjectFactory,pluckSender,articleService,pluckSearchTermExtractor,numberOfCommentsPerPage,serverData.env.userProfileUrlPrefix);var searchView=new guardian.r2.serverSidePluck.PluckSearchView(templateRenderer);var paginator=new guardian.r2.serverSidePluck.Paginator(numberOfCommentsPerPage);return new guardian.r2.serverSidePluck.PluckSearchController(searchService,searchView,paginator,serverData.parameters.searchString,serverData.parameters.commentPage)};this.createFeaturedCommentsController=function(){var service=new guardian.r2.serverSidePluck.FeaturedCommentsService(pluckObjectFactory,pluckSender);
var view=new guardian.r2.serverSidePluck.FeaturedCommentsView();var userProfileService=new guardian.r2.serverSidePluck.UserProfileService(pluckObjectFactory,config,pluckSender,profileDataHelper);return new guardian.r2.serverSidePluck.FeaturedCommentsController(service,view,serverData.articleInfo.sectionName,pluckCookieHandler.getLoggedInUserId(),userProfileService)};this.createTopKeywordsController=function(){var view=new guardian.r2.serverSidePluck.TopKeywordsView();var topKeywordsService=new guardian.r2.serverSidePluck.TopKeywordsService(serverData.env.topKeywordsUrl);return new guardian.r2.serverSidePluck.TopKeywordsController(view,userCommentService,topKeywordsService)};this.createCommentPopupWindowController=function(){var view=new guardian.r2.serverSidePluck.CommentPopupWindowView();return new guardian.r2.serverSidePluck.CommentPopupWindowController(view)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckAuthenticationService=function(config,pluckCookieHandler,urlStack,targetOpener){var showBoxParamName="showCommentBox";
var instance=this;this.isUserLoggedIntoPluck=function(){return pluckCookieHandler.cookieExists()};this.getLoggedInUserName=function(){if(!this.isUserLoggedIntoPluck()){throw"Can't get username because no pluck cookie exists."}return pluckCookieHandler.getLoggedInUserName()};this.getLoggedInUserId=function(){if(!this.isUserLoggedIntoPluck()){throw"Can't get username because no pluck cookie exists."}return pluckCookieHandler.getLoggedInUserId()};this.login=function(shouldShowCommentBoxOnReturn){if(instance.isUserLoggedIntoPluck()){return }urlStack.clearUrlStack();var destinationUrl=stripParamFromUrl(showBoxParamName,document.location.href);if(shouldShowCommentBoxOnReturn){destinationUrl=appendParam(destinationUrl,showBoxParamName,"true")}urlStack.pushUrlOntoStack(destinationUrl);if(targetOpener){window.opener.document.location=config.commentsSignUpUrl}else{document.location=config.commentsSignUpUrl}};this.isLoggedInUserThePageOwner=function(userIdOfPage){return pluckCookieHandler.getLoggedInUserId()===userIdOfPage
};this.signOut=function(){var destinationUrl=stripParamFromUrl(showBoxParamName,document.location.href);urlStack.pushUrlOntoStack(destinationUrl);document.location=config.signOutUrl};var appendParam=function(url,name,value){if(url.indexOf("?")===-1){return url+"?"+name+"="+value}return url+"&"+name+"="+value}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckBasicCookieHandler=function(){var cookieName="hd";var cookieMatcherString="(^|;)\\s*"+cookieName+"=([^|]+\\|([^|]*))?";this.cookieExists=function(){var regExp=new RegExp(cookieMatcherString);return regExp.test(document.cookie)};this.getLoggedInUserName=function(){var regExp=new RegExp(cookieMatcherString);return document.cookie.match(regExp)[3]}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckChalkboardDescriptionController=function(authenticationService,postCommentService,chalkboardDescriptionStatusView,chalkboardInfo,userProfileService,commentConverter,pluckEvents,loggedOnUser,config){var instance=this;
var errorHasOccurred=false;var destinationUrl=document.location;this.createFullyQualifiedPageUrl=function(currentPageUrl,locator){return currentPageUrl.replace("create",locator)};function onLoad(){addEvent("hiddenPostChalkboardPluckCommentButton","click",function(){authenticationService.login(false,instance.destinationUrl)})}this.chalkboardCreatedCallback=function(locator,description,heading){var commentBody=commentConverter.convert(description);var callback=instance.processResponse;callback.errorHandler=instance.handleError;chalkboardInfo.articleId=locator;chalkboardInfo.pageUrl=instance.createFullyQualifiedPageUrl(chalkboardInfo.pageUrl,locator);postCommentService.postComment(chalkboardInfo,commentBody,callback)};this.processResponse=function(){document.location=chalkboardInfo.pageUrl};this.handleError=function(errors){errorHasOccurred=true;chalkboardDescriptionStatusView.hideProgressBar();for(var i=0;i<errors.messages.length;i++){if(errors.messages[i].match(/rapid posting of multiple comments for quality reasons/)){chalkboardDescriptionStatusView.showPluckErrorArea("Too many chalkboards have been submitted from you in a short period of time. Please try again in a short while.");
return }}chalkboardDescriptionStatusView.showPluckErrorArea()};this.buildDestinationUrl=function(tempChalkboardId){return appendParameter(document.location.href,"tempChalkboardId="+tempChalkboardId)};this.userNotLoggedInCallback=function(tempChalkboardId){urlStack.pushUrlOntoStack(instance.buildDestinationUrl(tempChalkboardId));document.location=config.commentsSignUpUrl};window.chalkboardCreated=instance.chalkboardCreatedCallback;window.userNotLoggedIn=instance.userNotLoggedInCallback};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckChalkboardDescriptionStatusView=function(){var instance=this;this.showPluckErrorArea=function(errorMessage){var commentPluckErrorArea=document.getElementById("comment-pluck-error-area");if(errorMessage){commentPluckErrorArea.innerHTML="<p>"+errorMessage+"</p>"}commentPluckErrorArea.style.display="block"};this.hidePluckErrorArea=function(){document.getElementById("comment-pluck-error-area").style.display="none"};this.showProgressBar=function(){document.getElementById("comment-box-progress").style.display="block"
};this.hideProgressBar=function(){document.getElementById("comment-box-progress").style.display="none"}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckClippingController=function(commentService,annotationService,clippingView,charCounter){function trimTo150Chars(text){if(text.length<=150){return text}var trimmed=text.substring(0,151);var lastSpace=trimmed.lastIndexOf(" ");if(lastSpace!==-1){trimmed=trimmed.substring(0,lastSpace)}else{trimmed=trimmed.substring(0,150)}return trimmed+"&hellip;"}function stripHtml(str){return str.replace(/<\S[^><]*>/g,"")}function loadComments(){var commentIds=clippingView.getCommentIds();if(commentIds.length===0){return }var callback=function(comments){var availableComments=[];forEachElementOf(comments,function(comment){var commentId=comment.CommentKey.Key.replace(/CommentKey:/,"");var commentBody=stripHtml(comment.CommentBody);if(comment.ContentBlockingState==="Unblocked"){clippingView.setComment(commentId,trimTo150Chars(commentBody))
}else{clippingView.blockComment(commentId);clippingView.hideEditLink(commentId)}availableComments[commentId]=commentId});forEachElementOf(commentIds,function(commentId){if(!availableComments[commentId]){clippingView.showErrorMessage(commentId)}})};commentService.getCommentsByIds(commentIds,callback)}function loadAnnotations(){var clippingIds=clippingView.getClippingIds();if(clippingIds.length===0){return }var callback=function(annotations){if(!annotations||annotations.length===0){return null}forEachElementOf(annotations,function(annotation){var clippingId=annotation.CustomItemKey.Key.match(/ClippingId:(.*),/)[1];var annotationText=annotation.Content;var annotationUserKey=annotation.Author.UserKey.Key;if(annotationText!=="DELETED"&&clippingView.getClippingsUserId()===annotationUserKey){clippingView.setAnnotation(clippingId,annotationText)}})};annotationService.getAnnotations(clippingView.getClippingsUserId(),clippingIds,callback)}function saveAnnotation(clippingId){var annotationContentWithoutHtmlTags=stripHtml(clippingView.getEditableAnnotation());
annotationService.saveAnnotation(clippingView.getClippingsUserId(),clippingId,annotationContentWithoutHtmlTags)}function onLoad(){loadComments();loadAnnotations();clippingView.registerOpenListenerOnDialogBox(onDialogBoxOpen);clippingView.registerChangeListenerOnDialogBox(onDialogBoxChange);clippingView.registerSaveListenerOnDialogBox(saveAnnotation)}function onDialogBoxOpen(){copyAnnotationContent();onDialogBoxChange()}function onDialogBoxChange(){clippingView.registerKeyPressListenerOnEditAnnotationTextArea(charCounter.count);charCounter.configure(clippingView.setCharsLeft,clippingView.getEditableAnnotation,clippingView.setEditableAnnotation)}function copyAnnotationContent(){clippingView.setEditableAnnotation(clippingView.getAnnotationToBeEdited())}clippingView.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckClippingView=function(config){this.registerKeyPressListenerOnEditAnnotationTextArea=function(callback){addEvent(guardian.r2.dom.element.getElementsByCssSelector("textarea.annotation",document.getElementById("edit-note"))[0],"keyup",callback)
};this.registerSaveListenerOnDialogBox=function(callback){if(guardian.r2.editClippingController){var myCallback=function(){var clippingId=document.getElementById("edit-clipping-id").value;callback(clippingId)};guardian.r2.editClippingController.registerSaveListener(myCallback)}};this.registerOpenListenerOnDialogBox=function(callback){if(guardian.r2.editClippingController){guardian.r2.editClippingController.registerOpenListener(callback)}};this.registerChangeListenerOnDialogBox=function(callback){if(guardian.r2.editClippingController){guardian.r2.editClippingController.registerChangeListener(callback)}};this.addLoadEvent=function(callback){addSafeLoadEvent(callback)};function getTargetIds(fromElement,withClass){var targets=guardian.r2.dom.element.getElementsByCssSelector(fromElement);var ids=[];forEachElementOf(targets,function(target){ids.push(target.id.replace(new RegExp(withClass),""))});return ids}this.getCommentIds=function(){return getTargetIds("div.comment-clipping","comment-clipping-")
};this.setComment=function(commentId,commentText){guardian.r2.dom.element.getElementsByCssSelector(".clipping-trail-text",getComment(commentId))[0].innerHTML="<p>"+commentText+"</p>";removeClassName(getComment(commentId).getElementsByTagName("div")[0],"hidden")};this.blockComment=function(commentId){var commentTextElement=guardian.r2.dom.element.getElementsByCssSelector(".clipping-trail-text",getComment(commentId))[0];commentTextElement.innerHTML="<p>"+config.messages.commentBlocked+"</p>";guardian.r2.dom.element.addClassName(commentTextElement,"comment-blocked");removeClassName(getComment(commentId).getElementsByTagName("div")[0],"hidden")};this.hideEditLink=function(commentId){var clipping=getComment(commentId).parentNode;var editLinkToRemove=guardian.r2.dom.element.getElementsByCssSelector(".show-edit-clipping",clipping)[0];editLinkToRemove.parentNode.removeChild(editLinkToRemove);removeClassName(guardian.r2.dom.element.getElementsByCssSelector(".delete",clipping)[0],"separator")};this.showErrorMessage=function(commentId){var errorElement=guardian.r2.dom.element.getElementsByCssSelector(".comment-clipping-error",getComment(commentId))[0];
removeClassName(errorElement,"hidden")};this.getAnnotationToBeEdited=function(){var clippingId=document.getElementById("edit-clipping-id").value;var clippingElement=document.getElementById("clipping-"+clippingId);return guardian.r2.dom.element.getElementsByCssSelector(".annotation-content",clippingElement)[0].innerHTML};this.setAnnotation=function(clippingId,annotationContent){var clippingElement=document.getElementById("clipping-"+clippingId);guardian.r2.dom.element.getElementsByCssSelector(".annotation-content",clippingElement)[0].innerHTML=annotationContent;removeClassName(guardian.r2.dom.element.getElementsByCssSelector(".annotation",clippingElement)[0],"hidden")};this.getEditableAnnotation=function(){return guardian.r2.dom.element.getElementsByCssSelector("textarea.annotation",document.getElementById("edit-note"))[0].value};this.setEditableAnnotation=function(content){guardian.r2.dom.element.getElementsByCssSelector("textarea.annotation",document.getElementById("edit-note"))[0].value=content
};this.getClippingsUserId=function(){return document.getElementById("user-id").value};this.getClippingIds=function(){return getTargetIds(".clipping-contents","clipping-")};this.setCharsLeft=function(charsLeft){document.getElementById("annotation-chars-left").innerHTML=charsLeft};function getComment(commentId){return document.getElementById("comment-clipping-"+commentId)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentAbuseBoxView=function(){this.registerClickListenerOnOpenAbuseBoxButton=function(callback){var myCallback=function(event){var target=guardian.r2.event.getElement(event);if(target.className==="report-abuse"){var commentKey=target.parentNode.parentNode.id;callback(commentKey)}};addEvent("pluck-comments","click",myCallback);addEvent("pluck-single-comment","click",myCallback);addEvent("pluck-addressed-comment","click",myCallback);addEvent("pluck-comment-block","click",myCallback)}};guardian.r2.serverSidePluck.PluckCommentAbuseBoxView.prototype=new guardian.r2.serverSidePluck.PluckAbuseBoxView();
ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentBoxController=function(authenticationService,commentBoxView,charCounter,loggedInUser,userProfileService){var instance=this;var errorHasOccurred=false;function onLoad(){updateFormURLifInPopup();if(authenticationService.isUserLoggedIntoPluck()){userProfileService.getUserProfile(authenticationService.getLoggedInUserId(),function(loggedInUserInfo){if(loggedInUserInfo.hasCapability("postComment")){charCounter.configure(commentBoxView.setCharsLeft,commentBoxView.getCommentBodyWithoutBlockquotes,commentBoxView.setCommentBody);registerViewListeners()}else{commentBoxView.removePostCommentButtons()}});populateCommentBox()}else{updateFormURLToPleaseSignInBox();commentBoxView.registerClickListenerOnOpenCommentBoxButton(function(){authenticationService.login(true);return false});commentBoxView.swapFormForPostCommentButton()}}function updateFormURLToPleaseSignInBox(){var newFormURL=window.location.href+"?showCommentBox=true";
jQ("div#pluck-container form.post-your-comments").attr("action",newFormURL);jQ("div#login-container form.post-your-comments").attr("action",newFormURL);jQ("div#signed-in-no-at-cookie form").attr("action",newFormURL)}function updateFormURLifInPopup(){if(window.location.href.indexOf("popupcomments")!==-1){var currentTarget=jQ("div#pluck-container form.post-your-comments").attr("action");jQ("div#pluck-container form.post-your-comments").attr("action",currentTarget+"FromPopup")}}function addBlockquotesToSelectedText(){commentBoxView.addTagToSelectedText("blockquote")}function addBoldToSelectedText(){commentBoxView.addTagToSelectedText("b")}function addItalicToSelectedText(){commentBoxView.addTagToSelectedText("i")}function addLinkToSelectedText(){var url=commentBoxView.captureUserLink();var tagContents=null;if(url){if(!commentBoxView.isTextSelected()){tagContents=url}commentBoxView.addTagToSelectedText("a",[{name:"href",value:url}],tagContents)}}function registerViewListeners(){commentBoxView.registerClickListenerOnSignOutLink(instance.signOut);
commentBoxView.registerKeyPressListenerOnCommentTextArea(charCounter.count);commentBoxView.registerKeyPressListenerOnCommentTextArea(instance.validate);commentBoxView.registerClickListenerOnAddBlockQuoteButton(addBlockquotesToSelectedText);commentBoxView.registerClickListenerOnAddBoldButton(addBoldToSelectedText);commentBoxView.registerClickListenerOnAddItalicButton(addItalicToSelectedText);commentBoxView.registerClickListenerOnAddLinkButton(addLinkToSelectedText)}function setLoggedInUserInfo(loggedInUserInfo){instance.loggedInUserInfo=loggedInUserInfo}function isValid(){return commentBoxView.getCommentBody().length!==0}function isDirty(){return commentBoxView.getCommentBody().length!==0}function populateCommentBox(){userProfileService.getUserProfile(authenticationService.getLoggedInUserId(),function(loggedInUserInfo){setLoggedInUserInfo(loggedInUserInfo);var userName=authenticationService.getLoggedInUserName();commentBoxView.setOpenUserImage(loggedInUserInfo,userName);if(loggedInUserInfo.isStaff||loggedInUserInfo.isContributor){commentBoxView.setOpenUserTierInfoImage(loggedInUserInfo)
}else{if(loggedInUserInfo.isUntrusted){commentBoxView.showUserPremoderationWarning()}}commentBoxView.setOpenCommenterName(userName)})}this.signOut=function(){authenticationService.signOut()};this.validate=function(){if(isValid()){commentBoxView.enableSubmitButton()}else{commentBoxView.disableSubmitButton()}};jQ(document).ready(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentBoxView=function(){var instance=this;this.addLoadEvent=function(callback){addSafeLoadEvent(callback)};this.registerClickListenerOnOpenCommentBoxButton=function(callback){jQ("#signed-in-no-at-cookie input").click(callback)};this.registerClickListenerOnSignOutLink=function(callback){addEvent("sign-out-link","click",callback)};this.registerClickListenerOnSubmitCommentButton=function(callback){addEvent("submit-comment","click",callback)};this.registerKeyPressListenerOnCommentTextArea=function(callback){jQ("#comment-body").keyup(callback)};this.registerClickListenerOnAddBlockQuoteButton=function(callback){addEvent("add-blockquotes","click",callback)
};this.registerClickListenerOnAddBoldButton=function(callback){addEvent("add-bolds","click",callback)};this.registerClickListenerOnAddItalicButton=function(callback){addEvent("add-italics","click",callback)};this.registerClickListenerOnAddLinkButton=function(callback){addEvent("add-links","click",callback)};this.removePostCommentButtons=function(){var commentButtons=[document.getElementById("post-comment-div-top"),document.getElementById("post-comment-div-bottom")];forEachElementOf(commentButtons,function(button){button.parentNode.removeChild(button)})};this.setCommenterName=function(realName){document.getElementById("user-name").innerHTML=realName};this.setOpenCommenterName=function(realName){jQ("#open-user-name").html(realName)};this.showUserPremoderationWarning=function(){jQ(".user-premoderation-warning").show()};this.setCharsLeft=function(charsLeft){document.getElementById("chars-left").innerHTML=charsLeft};this.getCommentBody=function(){return document.getElementById("comment-body").value
};this.getCommentBodyWithoutBlockquotes=function(){return instance.getCommentBody().replace(/\<[\/]?blockquote\>/g,"")};this.setCommentBody=function(commentBody){document.getElementById("comment-body").value=commentBody};this.clearCommentBody=function(){document.getElementById("comment-body").value=""};this.showCommentBody=function(){document.getElementById("comment-box-edit").style.display="block"};this.hideCommentBody=function(){document.getElementById("comment-box-edit").style.display="none"};this.enableSubmitButton=function(){document.getElementById("submit-comment").disabled=false};this.disableSubmitButton=function(){document.getElementById("submit-comment").disabled=true};this.getCommentBodyElement=function(){return document.getElementById("comment-body")};function addTagInFirefox(tag,startIndexSelectedText,endIndexSelectedText,args,tagContents){var commentBodyText=instance.getCommentBody();var textBeforeOpeningTag=(startIndexSelectedText===0?"":commentBodyText.substring(0,startIndexSelectedText));
var textBetweeenTag=commentBodyText.substring(startIndexSelectedText,endIndexSelectedText);var textAfterClosingTag=(endIndexSelectedText===commentBodyText.length?"":commentBodyText.substring(endIndexSelectedText,commentBodyText.length));var commentBoxText=textBeforeOpeningTag+"<"+tag;if(args){forEachElementOf(args,function(element){commentBoxText+=(" "+element.name+'="'+element.value+'"')})}commentBoxText+=">";if(tagContents){commentBoxText+=tagContents}commentBoxText+=textBetweeenTag+"</"+tag+">"+textAfterClosingTag;instance.setCommentBody(commentBoxText)}function addTagInIe(tag,selection,args,tagContents){document.getElementById("comment-body").focus();var textRange=selection.createRange();var originalSelectedTextAreaText=textRange.text;if(textRange.parentElement().id==="comment-body"){textRange.text="<"+tag;if(args){forEachElementOf(args,function(element){textRange.text+=(" "+element.name+'="'+element.value+'"')})}textRange.text+=">";if(tagContents){textRange.text+=tagContents}textRange.text+=originalSelectedTextAreaText+"</"+tag+">"
}}function isBrowserThatSupportsCommentBodyElement(){var commentBodyElement=instance.getCommentBodyElement();return isNumber(commentBodyElement.selectionStart)&&isNumber(commentBodyElement.selectionEnd)}function isBrowserThatSupportsDocumentSelection(){return document.selection&&document.selection.createRange}this.addTagToSelectedText=function(tag,args,tagContents){var commentBodyElement=instance.getCommentBodyElement();if(isBrowserThatSupportsCommentBodyElement()){addTagInFirefox(tag,commentBodyElement.selectionStart,commentBodyElement.selectionEnd,args,tagContents)}else{if(isBrowserThatSupportsDocumentSelection()){addTagInIe(tag,document.selection,args,tagContents)}}};this.setOpenUserImage=function(loggedInUserInfo,userName){jQ("#open-user-image").attr("title",userName).attr("alt",userName).attr("src",loggedInUserInfo.photoUrl)};this.setOpenUserTierInfoImage=function(loggedInUserInfo){var tierInfoImage=document.createElement("img");tierInfoImage.src=commonStaticRoot+"images/communities/icons_"+loggedInUserInfo.userTier.toLowerCase()+"_28.gif";
tierInfoImage.alt=loggedInUserInfo.userTier;tierInfoImage.title=loggedInUserInfo.userTier;jQ(".author-role").append(tierInfoImage)};this.isTextSelected=function(){var commentBodyElement=instance.getCommentBodyElement();if(isBrowserThatSupportsCommentBodyElement()){return commentBodyElement.selectionStart!==commentBodyElement.selectionEnd}else{if(isBrowserThatSupportsDocumentSelection()){return document.selection.createRange().text.length>0}}return false};this.captureUserLink=function(){return prompt("Please enter a link","http://")};this.openCommunityStandardsLinkInNewWindow=function(){document.getElementById("community-standards-link").target="windowFromPopupComments"};this.setUsernameRequiredMessage=function(){document.getElementById("pluck-sign-in").style.display="block"};this.swapFormForPostCommentButton=function(){jQ(".post-your-comments-form").remove();jQ("#signed-in-no-at-cookie").show()}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentController=function(view){var instance=this;
function onLoad(){if(view.isAllComments()&&!view.hasComments()){view.addErrorMessage();setTimeout(reload,"5000")}if(typeof coreContentCommentCount!=="undefined"){if(coreContentCommentCount!==null){view.setCommentCount(coreContentCommentCount)}}}function reload(){window.location.reload(true)}view.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentCountController=function(commentCountService,commentCountView){function onLoad(){var callback=function(contentSummaries){for(var i=0;i<contentSummaries.length;++i){commentCountView.renderCommentCountFor(contentSummaries[i])}var itemsStillRequiringCommentCounts=commentCountView.getItemsRequiringCommentCounts();for(var j=0;j<itemsStillRequiringCommentCounts.length;++j){commentCountView.renderCommentCountFor(itemsStillRequiringCommentCounts[j],0)}};var itemsRequiringCommentCounts=commentCountView.getItemsRequiringCommentCounts();commentCountService.getCommentCounts(itemsRequiringCommentCounts,callback,true)
}commentCountView.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentCountView=function(){var cssIdentifierFor=function(discussionIdSet){if(discussionIdSet.shortUrl){return"shorturl"+discussionIdSet.shortUrl.replace(/\//g,"-")}else{return"comment-count-id-"+discussionIdSet.articleId}};var commentCountElementsForDiscussion=function(discussionIdSet){var cssIdentifier=cssIdentifierFor(discussionIdSet);var elementWithId=document.getElementById(cssIdentifier);if(elementWithId){return[elementWithId]}return guardian.r2.dom.element.getElementsByCssSelector("."+cssIdentifier,document.body)};var forEachCommentCountElementWithDiscussion=function(discussionIdSet,doThis){forEachElementOf(commentCountElementsForDiscussion(discussionIdSet),function(element){doThis(element)})};var forEachCommentCountAnchorWithDiscussion=function(discussionIdSet,doThis){forEachCommentCountElementWithDiscussion(discussionIdSet,function(element){if(element.tagName.toLowerCase()==="a"){doThis(element)
}})};var hasElementWithMatchingClass=function(elements,regexp){for(var i=0;i<elements.length;++i){var element=elements[i];if(element.tagName.toLowerCase()==="a"&&element.className.match(regexp)){return true}}return false};var commentCountElementExistsMatching=function(discussionIdSet,regexp){return hasElementWithMatchingClass(commentCountElementsForDiscussion(discussionIdSet),regexp)};var isPluckCommentable=function(discussionIdSet){return commentCountElementExistsMatching(discussionIdSet,/pluck-commentable/)};var isCommentingClosed=function(discussionIdSet){return commentCountElementExistsMatching(discussionIdSet,/commenting-closed/)};var showPostYourCommentLink=function(discussionIdSet){forEachCommentCountAnchorWithDiscussion(discussionIdSet,function(element){element.innerHTML="Post your comment";guardian.r2.dom.element.addClassName(element,"comment-count-set");guardian.r2.dom.element.addClassName(element,"comment-icon")})};var removePostYourCommentLink=function(discussionIdSet){forEachCommentCountAnchorWithDiscussion(discussionIdSet,function(element){element.parentNode.removeChild(element)
})};this.addLoadEvent=function(callback){jQ(document).ready(callback)};this.getItemsRequiringCommentCounts=function(){var commentTargets=guardian.r2.dom.element.getElementsByCssSelector(["a.comment-count-info","span.comment-count-info","p.comment-count-info"]);var idObjects=[];forEachElementOf(commentTargets,function(element){if(element.className.indexOf("comment-count-set")===-1){var idObject={};addMatchFrom(element.className,/comment-count-id-([0-9]+)/,idObject,"articleId");addMatchFrom(element.className.replace(/-/g,"/"),/shorturl([\w/]+)/,idObject,"shortUrl");if(idObject.shortUrl){idObjects.push(idObject)}}});return idObjects};var addMatchFrom=function(text,regex,idObject,identifierName){var match=text.match(regex);if(match){idObject[identifierName]=match[1]}};var setCommentCountOnElement=function(element,numberOfComments){guardian.r2.dom.element.addClassName(element,"comment-count-set");var linkCommentCounts=guardian.r2.dom.element.getElementsByCssSelector(".link-comment-count",element);
if(linkCommentCounts.length===0){linkCommentCounts=guardian.r2.dom.element.getElementsByCssSelector(".link-comment-count",element)}if(linkCommentCounts.length!==0){var numberOfCommentsInGuardianStyle=""+numberOfComments;var rgx=/(\d+)(\d{3})/;while(rgx.test(numberOfCommentsInGuardianStyle)){numberOfCommentsInGuardianStyle=numberOfCommentsInGuardianStyle.replace(rgx,"$1,$2")}linkCommentCounts[0].innerHTML=numberOfCommentsInGuardianStyle;var commentCountWords=guardian.r2.dom.element.getElementsByCssSelector(".link-comment-count-words",element)[0];if(commentCountWords){if(numberOfComments===1){commentCountWords.innerHTML="&nbsp;comment"}else{commentCountWords.innerHTML="&nbsp;comments"}}guardian.r2.dom.element.addClassName(element,"comment-icon");element.style.display="block"}};this.setCommentCount=function(discussionIdSet,numberOfComments){forEachCommentCountElementWithDiscussion(discussionIdSet,function(element){setCommentCountOnElement(element,numberOfComments)})};this.renderZeroCommentCountFor=function(discussionIdSet){if(isPluckCommentable(discussionIdSet)&&!isCommentingClosed(discussionIdSet)){showPostYourCommentLink(discussionIdSet)
}};this.renderCommentCountFor=function(discussionIdSet){if(discussionIdSet.numberOfComments>0){this.setCommentCount(discussionIdSet,discussionIdSet.numberOfComments)}else{this.renderZeroCommentCountFor(discussionIdSet)}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentView=function(templateRenderer,commentId,config,signInController,templateElementName){var renderPaginationInternal=function(targetElementName,paginationInfo){var targetElement=document.getElementById(targetElementName);var templateElementName="pluck-pagination-template";templateRenderer.renderTemplate(targetElement,templateElementName,paginationInfo);document.getElementById(targetElementName).style.display="block"};var renderAddressedCommentAuthor=function(addressedCommentAuthor){var author=document.getElementById("pluck-addressed-comment-author");author.innerHTML=addressedCommentAuthor;var addressedCommentAuthorInfo=document.getElementById("pluck-addressed-comment-author-info");addressedCommentAuthorInfo.style.display="block"
};var createDivForRenderingComments=function(){var baseElement=document.getElementById("pluck-comments");var targetElement=document.createElement("div");baseElement.appendChild(targetElement);return targetElement};var createDivForRenderingSingleComment=function(){var baseElement=document.getElementById("pluck-single-comment");var targetElement=document.createElement("div");baseElement.appendChild(targetElement);return targetElement};this.addLoadEvent=function(callback){jQ(document).ready(callback)};this.renderPagination=function(paginationInfo){paginationInfo.renderPageNumbers=true;renderPaginationInternal("pluck-pagination-top",paginationInfo);renderPaginationInternal("pluck-pagination-bottom",paginationInfo)};this.renderComments=function(commentData){var targetElement=createDivForRenderingComments();templateRenderer.renderTemplate(targetElement,templateElementName,commentData);document.getElementById("post-comment-div-top").style.display="block";if(commentData.TotalNumberOfComments>0){document.getElementById("post-comment-div-bottom").style.display="block"
}if(commentId){this.scrollToComment(config.commentKeyPrefix+commentId)}signInController.addListenersTo(targetElement)};this.renderSingleComment=function(commentData){var targetElement=createDivForRenderingSingleComment();templateRenderer.renderTemplate(targetElement,"pluck-single-comment-template",commentData)};function cumulativeOffset(element){var valueT=0,valueL=0;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;element=element.offsetParent}while(element);return returnOffset(valueL,valueT)}function returnOffset(l,t){var result=[l,t];result.left=l;result.top=t;return result}this.renderAddressedComment=function(addressedCommentData){var targetElement=document.getElementById("pluck-addressed-comment");templateRenderer.renderTemplate(targetElement,templateElementName,addressedCommentData);var addressedCommentAuthor=addressedCommentData.Comments[0].Author.displayName;renderAddressedCommentAuthor(addressedCommentAuthor)};function pluralise(originalText,numberOfComments){var suffix="";
if(originalText&&originalText.match(/\b(comment)s?\b/)){suffix=templateRenderer.templateFunctions.pluralise(" comment",Number(numberOfComments))}return numberOfComments+suffix}this.setCommentCount=function(commentCount){var targetList=guardian.r2.dom.element.getElementsByCssSelector("span.comment-count");forEachElementOf(targetList,function(element){element.innerHTML=pluralise(element.innerHTML,commentCount)});targetList=guardian.r2.dom.element.getElementsByCssSelector("span.comment-count-info");forEachElementOf(targetList,function(element){element.style.display="inline"})};this.showLoadingDialog=function(showAllComments){if(showAllComments){document.getElementById("progress-bar").style.display="block"}else{document.getElementById("pluck-loading-dialog").style.display="block"}};this.hideLoadingDialog=function(){if(document.getElementById("pluck-loading-dialog")){document.getElementById("pluck-loading-dialog").style.display="none"}if(document.getElementById("progress-bar")){document.getElementById("progress-bar").style.display="none"
}};this.showPluckErrorArea=function(){document.getElementById("pluck-error-area").style.display="block"};function scrollToElement(element){if(typeof element==="string"){element=document.getElementById(element)?document.getElementById(element):null}if(element!==null){var offset=cumulativeOffset(element);window.scrollTo(0,offset[1])}}this.scrollToComment=function(commentKey){if(document.getElementById(commentKey)){var pos=cumulativeOffset(document.getElementById(commentKey));window.scrollTo(0,pos[1]-(getCenterPosition().y/2))}};this.updateProgress=function(loadedCount,totalNumber){var loadPercentage=Math.ceil((loadedCount/totalNumber)*100)+"%";var progressBar=document.getElementById("progress-bar");progressBar.getElementsByTagName("span")[0].style.width=loadPercentage;progressBar.getElementsByTagName("p")[0].innerHTML="Loading "+loadPercentage+" complete"};this.linksOpenInNewWindow=function(){function openLinks(event){var anchor=getAncestorOfType(guardian.r2.event.getElement(event),"a");if(anchor&&anchor.className.indexOf("report-abuse")===-1&&anchor.className.indexOf("recommend")===-1&&anchor.className.indexOf("signin")){anchor.target="windowFromPopupComments"
}}var pluckContainer=document.getElementById("pluck-container");addEvent(pluckContainer,"click",openLinks)};this.registerClickListenerOnUpdateCommentsButtons=function(callback){function internalCallback(){callback();try{window.opener.document.location=window.opener.document.location.toString().split("?")[0]}catch(e){}}var pluckContainer=document.getElementById("pluck-container");addClickListenersToMatchingElements(pluckContainer,"input.refresh-button",internalCallback)};this.scrollToTopOfComments=function(){scrollToElement("pluck-container")};this.hasComments=function(){return jQ("#pluck-comment-block").length!==0||jQ("#discussion-comments").length!==0};this.isAllComments=function(){return window.location.href.indexOf("showallcomments=true")!==-1};this.commentPosted=function(){return window.location.href.indexOf("#end-of-comments")!==-1};this.addErrorMessage=function(){var errorMessage="There was a problem retrieving comments, we will try again ";if(this.commentPosted()){errorMessage="<p>Your comment has been posted. We'll take you to your comment"
}errorMessage+=' in just a few seconds, or you can click <a href="'+window.location.href+'">here</a> to manually load all comments.</p>';jQ("#pluck-container").append(errorMessage)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckEvents=function(){var events={};this.register=function(eventName,functionToRegister){if(!events[eventName]){events[eventName]=[]}events[eventName][events[eventName].length]=functionToRegister};this.fire=function(eventName){if(events[eventName]){forEachElementOf(events[eventName],function(functionToFire){functionToFire()})}};this.clear=function(eventName){events[eventName]=[]}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckHashCookieHandler=function(){var cookieName="at";this.cookieExists=function(){return readCookie(cookieName)!==null};this.getLoggedInUserName=function(){var atCookieBody=readCookie("at");if(!atCookieBody){return null}var loggedInUserName=atCookieBody.match(/&a=([^&]+)&/)[1];return loggedInUserName
};this.getLoggedInUserId=function(){var atCookieBody=readCookie(cookieName);if(!atCookieBody){return null}var loggedInUserId=atCookieBody.match(/u=([^&]+)&/)[1];return loggedInUserId}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckRecommendationController=function(recommendationService,recommendationView){var instance=this;function onLoad(){recommendationView.registerClickListenerOnRecommendButton(instance.recommend)}this.processResponse=function(comment,callback){callback(comment.NumberOfRecommendations)};this.recommend=function(commentKey,callback){var recommendCallback=function(comment){instance.processResponse(comment,callback)};recommendationService.recommend(commentKey,recommendCallback)};recommendationView.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckRecommendationService=function(pluckObjectFactory,pluckSender){this.recommend=function(commentId,callback){var responseCallback=function(responseBatch){var forEachElementCallback=function(response){if(response.Comment){callback(response.Comment)
}};forEachElementOf(responseBatch.Responses,forEachElementCallback)};var commentRecommendation=pluckObjectFactory.newRecommendActionForComment(commentId);var commentKey=pluckObjectFactory.newCommentKeyWithoutPrefix(commentId);pluckSender.submit(responseCallback,commentRecommendation,commentKey)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckRecommendationView=function(){this.addLoadEvent=function(callback){addEvent(document,"load",callback)};this.registerClickListenerOnRecommendButton=function(callback){var myCallback=function(event){var target=guardian.r2.event.getElement(event);if(target.className==="recommend"){var commentKey=target.parentNode.parentNode.id;var updateNumberOfRecommendations=function(numberRecommendations){var elementsToSearch=target.parentNode.childNodes;for(var i=0;i<elementsToSearch.length;i++){if(elementsToSearch[i].className&&elementsToSearch[i].className.indexOf("recommended")!==-1){elementsToSearch[i].innerHTML="("+numberRecommendations+")";
break}}disableAnchorTag(target)};callback(commentKey,updateNumberOfRecommendations)}};addEvent("pluck-comments","click",myCallback);addEvent("pluck-single-comment","click",myCallback);addEvent("pluck-addressed-comment","click",myCallback)};function disableAnchorTag(anchorTagElement){var anchorTagText=anchorTagElement.innerHTML;var anchorTagParent=anchorTagElement.parentNode;anchorTagParent.replaceChild(document.createTextNode(anchorTagText),anchorTagElement)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckReportAbuseService=function(pluckObjectFactory,pluckSender){this.reportAbuse=function(abuseReport,callback){var responseCallback=function(responseBatch){callback()};delegateErrorHandler(responseCallback,callback);var reportAbuseAction=pluckObjectFactory.newReportAbuseAction(abuseReport);pluckSender.submit(responseCallback,reportAbuseAction)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckSearchController=function(searchService,searchView,paginator,searchString,onPage){function getSearchResultsAndRender(){var pageNumber=onPage?onPage:1;
function callback(searchResults){searchView.renderSearchResults(searchResults);var numberOfSearchResults=searchResults.Responses[0].SearchResult.NumberOfSearchResults;var urlParams={search:searchString};paginator.render(pageNumber,numberOfSearchResults,urlParams,searchView.renderPagination)}callback.errorHandler=function(){searchView.showPluckErrorArea()};searchService.searchComments(searchString,pageNumber,callback)}searchView.addLoadEvent(getSearchResultsAndRender)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckSearchTermExtractor=function(){this.extractTokens=function(searchTerm){var booleanTerms=["not","and","or"];var regex=/[^\-_a-zA-Z0-9\*\?]/;var tokens=searchTerm.split(regex);var filteredTokens=[];for(var i=0;i<tokens.length;i++){var token=tokens[i];if(token.length>0){if(token[0]==="-"){token=token.substring(1)}var tokenIsAlreadyThere=false;var tokenIsBoolean=false;for(var j=0;j<booleanTerms.length;j++){if(token===booleanTerms[j]){tokenIsBoolean=true
}}for(var k=0;k<filteredTokens.length;k++){if(token===filteredTokens[k]){tokenIsAlreadyThere=true}}if(!tokenIsBoolean&&!tokenIsAlreadyThere){filteredTokens.push(token)}}}return filteredTokens}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckSearchView=function(templateRenderer){var instance=this;this.addLoadEvent=function(onLoadCallback){addSafeLoadEvent(onLoadCallback)};this.renderSearchResults=function(searchResults){var targetElement=document.getElementById("pluck-search-results");var templateElementName="pluck-search-results-template";templateRenderer.renderTemplate(targetElement,templateElementName,searchResults.Responses[0].SearchResult);renderDefaultSearchResultSliceInfo(searchResults.Responses[0].SearchResult.NumberOfSearchResults)};this.renderPagination=function(paginationInfo){paginationInfo.renderPageNumbers=true;var targetElement=document.getElementById("pluck-pagination-bottom");var templateElementName="pluck-pagination-template";templateRenderer.renderTemplate(targetElement,templateElementName,paginationInfo);
targetElement.style.display="block";renderCurrentSearchResultsSliceInformation(paginationInfo.currentSliceInformation)};this.showPluckErrorArea=function(){if(document.getElementById("pluck-error-area")){document.getElementById("pluck-error-area").style.display="block"}};function renderDefaultSearchResultSliceInfo(numberOfSearchResults){if(numberOfSearchResults==="0"){document.getElementById("search-result-slice-info").style.display="none";return }renderCurrentSearchResultsSliceInformation("1 - "+numberOfSearchResults);renderSearchResultsTotal(numberOfSearchResults)}function renderSearchResultsTotal(totalNumberOfSearchResults){var searchResultsTotal=document.getElementById("search-results-total");searchResultsTotal.innerHTML=totalNumberOfSearchResults}function renderCurrentSearchResultsSliceInformation(searchResultSliceInformation){var currentSearchResultSlice=document.getElementById("current-search-results-slice");currentSearchResultSlice.innerHTML=searchResultSliceInformation}};ensurePackage("guardian.r2.serverSidePluck");
guardian.r2.serverSidePluck.PluckUserAbuseBoxView=function(){var instance=this;this.registerClickListenerOnOpenAbuseBoxButton=function(callback){var myCallback=function(event){guardian.r2.event.stop(event);callback(document.getElementById("user-id").value)};addEvent("report-abuse-box-link","click",myCallback)};this.showReportAbuseBoxLink=function(){document.getElementById("report-abuse-box-link-container").style.display="block"};this.getAbuseDescription=function(){return instance.getRawAbuseDescription()};this.init=function(){this.showReportAbuseBoxLink()};this.disableOpenAbuseBoxButton=function(){var linkContainer=document.getElementById("report-abuse-box-link-container");var removedAbuseLink=linkContainer.removeChild(document.getElementById("report-abuse-box-link"));linkContainer.innerHTML=removedAbuseLink.innerHTML}};guardian.r2.serverSidePluck.PluckUserAbuseBoxView.prototype=new guardian.r2.serverSidePluck.PluckAbuseBoxView();ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserClippingsAbuseBoxView=function(){var instance=this;
this.getAbuseDescription=function(){return"User: "+document.getElementById("user-name").value+"; Page: CLIPPINGS; Collection: "+document.getElementById("collection-name").value+"; "+instance.getRawAbuseDescription()}};guardian.r2.serverSidePluck.PluckUserClippingsAbuseBoxView.prototype=new guardian.r2.serverSidePluck.PluckUserAbuseBoxView();ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserCommentController=function(service,view,pageNumber,paginator,r2CommentDataService,renderer){if(!pageNumber){pageNumber=1}function onLoad(){var callback=function(commentData){renderer.setAfterRender(function(commentData){r2CommentDataService.getCommentKeywords(commentData,view.renderCommentKeywords);paginator.render(pageNumber,commentData.TotalNumberOfComments,null,view.renderPagination)});renderer.render(commentData)};callback.errorHandler=handleError;service.getUserCommentsForPage(pageNumber,callback)}function handleError(){view.showPluckErrorArea()}view.addLoadEvent(onLoad)
};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserCommentRenderer=function(view,authenticationService,profilePageUser,profileDataHelper){var afterRenderFunc;this.setAfterRender=function(func){afterRenderFunc=func};this.render=function(commentData){commentData.userProfileData=profileDataHelper.getUserProfileData(commentData.author);commentData.isUserLoggedIntoPluck=authenticationService.isUserLoggedIntoPluck();commentData.isLoggedInUserThePageOwner=authenticationService.isLoggedInUserThePageOwner(profilePageUser.id);if(commentData.userProfileData.hasNeverCommented()||commentData.userProfileData.hasCapability("postComment")){view.renderComments(commentData);if(afterRenderFunc){afterRenderFunc(commentData)}if(!commentData.userProfileData.isBanned&&commentData.isUserLoggedIntoPluck&&commentData.isLoggedInUserThePageOwner){view.showEditorsMessage()}}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserCommentView=function(templateRenderer){var renderPaginationInternal=function(targetElementName,paginationInfo){paginationInfo.renderPageNumbers=false;
var targetElement=document.getElementById(targetElementName);var templateElementName="pluck-pagination-template";templateRenderer.renderTemplate(targetElement,templateElementName,paginationInfo);document.getElementById(targetElementName).style.display="block"};this.addLoadEvent=function(callback){addSafeLoadEvent(callback)};this.renderComments=function(commentData){var targetElement=document.getElementById("pluck-comments");var templateElementName="pluck-comments-template";templateRenderer.renderTemplate(targetElement,templateElementName,commentData);document.getElementById("pluck-comment-container").style.display="block"};this.renderCommentKeywords=function(commentKey,keywordFragment){document.getElementById("comment-keywords-"+commentKey).innerHTML=keywordFragment};this.renderPagination=function(paginationInfo){renderPaginationInternal("pluck-pagination-top",paginationInfo);renderPaginationInternal("pluck-pagination-bottom",paginationInfo)};this.showEditorsMessage=function(){if(document.getElementById("editors-msg")){document.getElementById("editors-msg").style.display="block"
}};this.showPluckErrorArea=function(){if(document.getElementById("pluck-error-area").style.display==="none"){document.getElementById("pluck-comments-error-area").style.display="block"}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserLatestCommentsController=function(service,view,renderer){function onLoad(){var callback=function(commentData){renderer.render(commentData)};callback.errorHandler=handleError;service.getNUserComments(5,callback)}function handleError(){view.showPluckErrorArea()}view.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserLatestCommentsView=function(templateRenderer){this.addLoadEvent=function(callback){addSafeLoadEvent(callback)};this.renderComments=function(commentData){var targetElement=document.getElementById("pluck-latest-comments");var templateElementName="pluck-latest-comments-template";templateRenderer.renderTemplate(targetElement,templateElementName,commentData);document.getElementById("pluck-recent-activity-container").style.display="block"
};this.showEditorsMessage=function(){if(document.getElementById("editors-msg")){document.getElementById("editors-msg").style.display="block"}};this.showPluckErrorArea=function(){if(document.getElementById("pluck-error-area").style.display==="none"){document.getElementById("pluck-recent-activity-error-area").style.display="block"}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserProfileAbuseBoxView=function(){var instance=this;this.getAbuseDescription=function(){return"User: "+document.getElementById("user-name").value+"; Page: USER PROFILE; "+instance.getRawAbuseDescription()}};guardian.r2.serverSidePluck.PluckUserProfileAbuseBoxView.prototype=new guardian.r2.serverSidePluck.PluckUserAbuseBoxView();ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUsersReviewController=function(view,authenticationService){function onLoad(){if(!authenticationService.isUserLoggedIntoPluck()){view.showNoUserNameMessage()}view.updateReviewRating(3)
}view.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUsersReviewView=function(filmKey){this.addLoadEvent=function(callback){addEvent(document,"load",function(){var reviewsIframe=document.getElementById("reviewsiframe").contentWindow.document;addEvent(reviewsIframe,"load",function(){callback()})})};this.updateReviewRating=function(ratingValue){var ratingInput;var timerId=setInterval(function(){if(document.getElementById("reviewsiframe")&&document.getElementById("reviewsiframe").contentWindow&&document.getElementById("reviewsiframe").contentWindow.document){ratingInput=document.getElementById("reviewsiframe").contentWindow.document.getElementById(filmKey+"Rating-value");clearInterval(timerId);if(ratingInput){ratingInput.value=ratingValue}}},100)};this.showNoUserNameMessage=function(){if(document.getElementById("userMustHaveUserName1")&&document.getElementById("userMustHaveUserName2")){document.getElementById("userMustHaveUserName1").style.display="";
document.getElementById("userMustHaveUserName2").style.display="";var message1=guardian.r2.dom.element.getElementsByCssSelector("a",document.getElementById("userMustHaveUserName1"))[0];addEvent(message1,"click",function(){urlStack.clearUrlStack();urlStack.pushUrlOntoStack(document.location)});var message2=guardian.r2.dom.element.getElementsByCssSelector("a",document.getElementById("userMustHaveUserName2"))[0];addEvent(message2,"click",function(){urlStack.clearUrlStack();urlStack.pushUrlOntoStack(document.location)})}}};ensurePackage("guardian.r2.serverSidePluck.Pluck");guardian.r2.serverSidePluck.TemplateRenderer=function(config,dateUtil,articleInfo,profilePageUser,pageId){var instance=this;var getCommentId=function(comment){var commentKey=comment.CommentKey.Key;return commentKey.match(/^(CommentKey:)?(.*)/)[2]};this.templateFunctions={pluralise:function(string,value){if(Number(value)===1){return string}return string+"s"},isBlocked:function(){return true},formatDateTime:function(originalDateTime,messageDateTime){return dateUtil.formatDate(originalDateTime,messageDateTime)
},toLowerCase:function(string){return string.toLowerCase()},createCommentLinkUrl:function(comment,articleUrl){var url=articleUrl?articleUrl:articleInfo.pageUrl;var articleUrlWithParamsRemoved=url.match(/([^\?]+)/)[1];var commentId=getCommentId(comment);return articleUrlWithParamsRemoved+"?showallcomments=true#CommentKey:"+commentId},createClipLinkUrl:function(comment){var addClippingsUrl=config.addClippingsUrl;var commentId=getCommentId(comment);var contributor=escape(comment.Author.displayName);return addClippingsUrl+"?commentId="+commentId+"&commenterUserName="+contributor+"&r2PageId="+pageId},generateCommentPageLink:function(pageNumber,label,queryStringParameters){label=label?label:pageNumber;var url;if(profilePageUser.id){url=profilePageUser.pageUrl+"/comments"}else{url=articleInfo.pageUrl}var queryString="";if(queryStringParameters){for(var key in queryStringParameters){if(queryStringParameters.hasOwnProperty(key)){var value=queryStringParameters[key];queryString+="&"+key+"="+escape(value)
}}}return pageNumber===null?"&nbsp;":'<a href="'+url+"?commentpage="+pageNumber+queryString+'">'+label+"</a>"},highlightTokens:function(stringToHighLight,searchTokens){function replaceFunction(matchedWord){return'<span class="search-term">'+matchedWord+"</span>"}var result=stringToHighLight;for(var i=0;i<searchTokens.length;i++){var regExp=new RegExp("\\b"+searchTokens[i]+"\\b","gi");result=result.replace(regExp,replaceFunction)}return result},extractDomain:function(url){var regExp=new RegExp("http://([^/|$]*)","gi");var m=regExp.exec(url);if(!m){return null}return m[1]},getCommentBlockedMessage:function(){return config.messages.commentBlocked}};this.renderTemplate=function(targetElement,templateElementName,data){data.staticRoot=config.staticRoot;data.articleInfo=articleInfo;data._MODIFIERS=instance.templateFunctions;targetElement.innerHTML=TrimPath.processDOMTemplate(templateElementName,data)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.TopKeywordsController=function(view,userCommentService,topKeywordsService){var NUMBER_OF_COMMENTS=100;
function extractContentIds(commentData){var contentIds=[];for(var i=0;i<commentData.UserActivities.length;i++){var activity=commentData.UserActivities[i];if(activity.Comment!==undefined){contentIds.push(activity.Comment.CommentedOnKey)}}return contentIds}function processTopKeywordsHtmlResponse(htmlSnippet){if(htmlSnippet&&trim(htmlSnippet).length>0){view.renderTopKeywords(htmlSnippet)}}function processNUserCommentsResponse(commentData){topKeywordsService.getTopKeywordsHtml(extractContentIds(commentData),processTopKeywordsHtmlResponse)}function onLoad(){userCommentService.getNUserComments(NUMBER_OF_COMMENTS,processNUserCommentsResponse)}view.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.TopKeywordsService=function(serverUrl){function buildUrl(contentIds){var url=serverUrl;for(var i=0;i<contentIds.length;i++){url+=i===0?"?contentIds=":",";url+=contentIds[i]}return url}this.getTopKeywordsHtml=function(contentIds,callback){var url=buildUrl(contentIds);
var ajaxRequest=new guardian.r2.ajax.Request(url,{method:"get",onSuccess:function(transport){callback(transport.responseText)}})}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.TopKeywordsView=function(){this.addLoadEvent=function(callback){addSafeLoadEvent(callback)};this.renderTopKeywords=function(htmlSnippet){document.getElementById("top-keywords-list").innerHTML=htmlSnippet;document.getElementById("top-keywords").style.display="block"}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.UserInfoCommentModifier=function(authenticationService,userProfileService){this.modify=function(commentData,callback){if(!authenticationService.isUserLoggedIntoPluck()){commentData.currentUser=null;callback(commentData)}else{userProfileService.getUserProfile(authenticationService.getLoggedInUserId(),function(loggedInUserInfo){commentData.currentUser=loggedInUserInfo;callback(commentData)})}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.UserProfileController=function(profilePageData,userProfileService,userProfileView,authenticationService,config,isEditProfilePage){function createEditOrProfileData(){return{title:(isEditProfilePage?"My comments":"Edit profile"),link:profilePageData.pageUrl+(isEditProfilePage?"":"?plckPersonaPage=PersonaProfile")}
}function onLoad(){function callback(pluckProfilePageUser){pluckProfilePageUser.isUserLoggedIntoPluck=authenticationService.isUserLoggedIntoPluck();pluckProfilePageUser.isLoggedInUserThePageOwner=authenticationService.isLoggedInUserThePageOwner(profilePageData.id);pluckProfilePageUser.signOutUrl=config.signOutUrl;pluckProfilePageUser.editOrComments=createEditOrProfileData();if(pluckProfilePageUser.location||pluckProfilePageUser.age||pluckProfilePageUser.gender||pluckProfilePageUser.aboutMe||pluckProfilePageUser.interests||pluckProfilePageUser.realName||pluckProfilePageUser.webPage){pluckProfilePageUser.noProfileData=false}else{pluckProfilePageUser.noProfileData=true}if(pluckProfilePageUser.isBanned){userProfileView.showNoProfileMessage()}else{userProfileView.renderUserProfile(pluckProfilePageUser);if(pluckProfilePageUser.isUserLoggedIntoPluck&&pluckProfilePageUser.isLoggedInUserThePageOwner){userProfileView.showEditorsMessage();userProfileView.showEditProfileWidget()}}}callback.errorHandler=handleError;
userProfileService.getUserProfile(profilePageData.id,callback)}function handleError(){userProfileView.showPluckErrorArea()}userProfileView.addLoadEvent(onLoad)};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.UserProfileService=function(pluckObjectFactory,config,pluckSender,profileDataHelper){var jsc=0;this.getUserProfile=function(userId,callback){if(typeof (sspSitesProxies)!=="undefined"){getUserProfileFromSSP(userId,callback)}else{getUserProfileFromPluck(userId,callback)}};function getUserProfileFromPluck(userId,callback){var userKey=pluckObjectFactory.newUserKey(userId);var extractUserProfileDataCallback=function(responseBatch){var userResponseData=responseBatch.Responses[0].User;var profileData=profileDataHelper.getUserProfileData(userResponseData);callback(profileData)};delegateErrorHandler(extractUserProfileDataCallback,callback);pluckSender.submit(extractUserProfileDataCallback,userKey)}function getUserProfileFromSSP(userId,callback){var extractUserProfileDataCallback=function(responseBatch){var userResponseData=responseBatch.Responses[0].User;
var profileData=profileDataHelper.getUserProfileData(userResponseData);callback(profileData)};var jsonpCallbackName="pluckUserProfileServiceCallback_"+jsc++;window[jsonpCallbackName]=function(tmp){extractUserProfileDataCallback(tmp);window[jsonpCallbackName]=undefined;try{delete window[jsonpCallbackName]}catch(e){}};jQuery.ajax({type:"GET",url:config.userProfileServiceUrl,data:{userId:userId,callback:jsonpCallbackName},cache:true,dataType:"script"})}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.UserProfileView=function(templateRenderer){this.renderUserProfile=function(pluckProfilePageUser){var targetElement=document.getElementById("pluck-profile");var templateElementName="pluck-profile-template";templateRenderer.renderTemplate(targetElement,templateElementName,pluckProfilePageUser)};this.showEditProfileWidget=function(){if(document.getElementById("pluck-profile-edit")){document.getElementById("pluck-profile-edit").style.display="block"}};this.addLoadEvent=function(loadCallback){addSafeLoadEvent(loadCallback)
};this.showEditorsMessage=function(){if(document.getElementById("editors-msg")){document.getElementById("editors-msg").style.display="block"}};this.showNoProfileMessage=function(){if(document.getElementById("no-profile-message")){document.getElementById("no-profile-message").style.display="block"}};this.showPluckErrorArea=function(){document.getElementById("pluck-error-area").style.display="block"}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckArticleService=function(pluckObjectFactory,pluckSender){var maxNumberOfArticlesInABatch=20;var buildSummary=function(response){return{articleId:response.Article.ArticleKey.Key,numberOfComments:response.Article.Comments.NumberOfComments,pageUrl:response.Article.PageUrl,articleTitle:response.Article.PageTitle}};this.getArticleSummaries=function(articleIds,callback,ignoreErrors){if(articleIds.length===0){return }var numberOfArticleBatches=Math.ceil(articleIds.length/maxNumberOfArticlesInABatch);var articleSummaries=[];
var callbackCount=0;var myCallback=function(responseBatch){callbackCount++;for(var i=0;i<responseBatch.Responses.length;i++){articleSummaries.push(buildSummary(responseBatch.Responses[i]))}if(callbackCount===numberOfArticleBatches){callback(articleSummaries)}};if(ignoreErrors){myCallback.errorHandler=function(errors){myCallback(errors.responseBatch)}}var args=[];for(var i=0;i<articleIds.length;i++){args.push(pluckObjectFactory.newArticleKey(articleIds[i]))}for(var j=0;j<numberOfArticleBatches;j++){var slicedArgs=args.slice(j*maxNumberOfArticlesInABatch,Math.min(((j+1)*maxNumberOfArticlesInABatch),args.length));slicedArgs=[myCallback].concat(slicedArgs);pluckSender.submit.apply(pluckSender,slicedArgs)}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentCountService=function(config){ItemRegister=function(itemsRequiringCommentCounts,fieldName,serviceIdsParameter,serviceUrl){var instance=this;instance.list=[];instance.map={};instance.serviceTempCallbackName=fieldName+"CommentCountServiceCallback";
for(var i=0;i<itemsRequiringCommentCounts.length;++i){var item=itemsRequiringCommentCounts[i];var id=item[fieldName];instance.list.push(id);instance.map[id]=item}this.processCountsFrom=function(itemUpdates){for(var i=0;i<itemUpdates.length;++i){var itemUpdate=itemUpdates[i];var id=itemUpdate[fieldName];instance.map[id].numberOfComments=itemUpdate.numberOfComments}};this.updateItemsWithCountsFromService=function(callbackFunction){window[instance.serviceTempCallbackName]=function(itemUpdatesFromService){instance.processCountsFrom(itemUpdatesFromService);callbackFunction(itemsRequiringCommentCounts);window[instance.serviceTempCallbackName]=undefined;try{delete window[instance.serviceTempCallbackName]}catch(e){}};var requestParams={callback:instance.serviceTempCallbackName};requestParams[serviceIdsParameter]=instance.list.join(",");jQuery.ajax({type:"GET",url:serviceUrl,data:requestParams,cache:true,dataType:"script",failure:function(){callbackFunction(itemsRequiringCommentCounts)}})}};this.getCommentCounts=function(itemsRequiringCommentCounts,callback,ignoreErrors){var shortUrlRegister;
var gp_sites=/^(www\.)?(kable|smarthealthcare|guardianpublic)\./;if(itemsRequiringCommentCounts.length===0){return }for(var i=0;i<itemsRequiringCommentCounts.length;++i){itemsRequiringCommentCounts[i].numberOfComments=0}if(document.location.host.match(gp_sites)){shortUrlRegister=new ItemRegister(itemsRequiringCommentCounts,"articleId","content-ids",config.commentCountsServiceUrl)}else{shortUrlRegister=new ItemRegister(itemsRequiringCommentCounts,"shortUrl","short-urls",config.discussionCommentCountsServiceUrl)}shortUrlRegister.updateItemsWithCountsFromService(callback)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckCommentService=function(pluckObjectFactory,pluckSender,config,articleService){var instance=this;var numberOfCommentsPerPage;var numberOfCommentsPerSlice=5;var numberOfSlicesPerPage=1;this.TIME_ASCENDING_ORDER="TimeStampAscending";this.TIME_DESCENDING_ORDER="TimeStampDescending";this.setNumberOfCommentsPerPage=function(_numberOfCommentsPerPage){instance.numberOfCommentsPerPage=_numberOfCommentsPerPage;
numberOfCommentsPerSlice=Math.min(config.pluckMaxNumberPerPage,_numberOfCommentsPerPage);numberOfSlicesPerPage=Math.ceil(_numberOfCommentsPerPage/config.pluckMaxNumberPerPage)};this.getNumberOfCommentsPerPage=function(){return instance.numberOfCommentsPerPage};this.getComments=function(articleId,pageNumber,commentSortOrder,onCompleteCallback,progressCallback){if(!pageNumber){pageNumber=1}getManyCommentsForAbstractArticlePage(articleId,pageNumber,commentSortOrder,onCompleteCallback,progressCallback)};this.getAllComments=function(articleId,commentSortOrder,onCompleteCallback,progressCallback){var callback=function(articleSummaries){var totalNumComments=Number(articleSummaries[0].numberOfComments);instance.setNumberOfCommentsPerPage(totalNumComments);if(totalNumComments!==0){getManyCommentsForAbstractArticlePage(articleId,1,commentSortOrder,onCompleteCallback,progressCallback)}else{onCompleteCallback(createCommentData([],totalNumComments,null))}};articleService.getArticleSummaries([articleId],callback,true)
};this.getCommentsByIds=function(commentIds,callback){var pluckCallback=function(responseBatch){var comments=[];for(var i=0;i<responseBatch.Responses.length;i++){comments.push(responseBatch.Responses[i].Comment)}callback(comments)};pluckCallback.errorHandler=function(errors){pluckCallback(errors.responseBatch)};var args=[pluckCallback];for(var i=0;i<commentIds.length;i++){args.push(pluckObjectFactory.newCommentKey(commentIds[i]))}pluckSender.submit.apply(pluckSender,args)};function getManyCommentsForAbstractArticlePage(articleId,pageNumber,commentSortOrder,onCompleteCallback,progressCallback){var startSliceNumber=((pageNumber-1)*numberOfSlicesPerPage)+1;var endSliceNumber=pageNumber*numberOfSlicesPerPage;var responseCallback=function(responseBatches){var comments=[];var totalNumberOfComments=0;var messageTime;for(var i=0;i<responseBatches.length;i++){var responseBatch=responseBatches[i];totalNumberOfComments=responseBatch.Responses[0].CommentPage.NumberOfComments;messageTime=responseBatch.Messages[0].MessageTime;
var commentPage=responseBatch.Responses[0].CommentPage;comments[commentPage.OnPage-startSliceNumber]=commentPage.Comments}onCompleteCallback(createCommentData(mergeComments(comments),totalNumberOfComments,messageTime))};var progressCallbackWrapper=function(responseBatch){if(progressCallback){var commentPage=responseBatch.Responses[0].CommentPage;progressCallback(commentPage.Comments.length,commentPage.NumberOfComments)}};delegateErrorHandler(responseCallback,onCompleteCallback);var commentPages=[];for(var commentSliceNumber=startSliceNumber;commentSliceNumber<=endSliceNumber;commentSliceNumber++){commentPages.push(pluckObjectFactory.newCommentPage(articleId,numberOfCommentsPerSlice,commentSliceNumber,commentSortOrder))}if(commentPages.length>0){pluckSender.submitIndividually(responseCallback,commentPages,progressCallbackWrapper)}}function mergeComments(comments){var allComments=[];for(var i=0;i<comments.length;++i){if(comments[i]){allComments=allComments.concat(comments[i])}}return allComments
}function createCommentData(comments,totalNumberOfComments,messageTime){var profileDataHelper=new guardian.r2.serverSidePluck.ProfileDataHelper();profileDataHelper.convertAuthorInfoInCommentArray(comments);replaceLineBreaks(comments);var data={Comments:comments,MessageTime:messageTime,TotalNumberOfComments:totalNumberOfComments};return data}function replaceLineBreaks(comments){for(var i=0;i<comments.length;i++){comments[i].CommentBody=comments[i].CommentBody.replace(/\r\n/g,"<br/>")}}this.lookupComment=function(commentId,callback,errorHandler){var pluckSenderCallback=function(responseBatch){var comments=[responseBatch.Responses[0].Comment];var messageTime=responseBatch.Messages[0].MessageTime;var addressedCommentData=createCommentData(comments,1,messageTime);callback(addressedCommentData)};var commentKey=pluckObjectFactory.newCommentKey(commentId);pluckSender.submit(pluckSenderCallback,commentKey)};this.getAllCommentsSinceComment=function(articleId,commentId,resultCallback,sortOrder){var comments=[];
var pageNumber=1;function callback(commentData){var dataContainsCommentId=false;if(commentData){for(var i=0;i<commentData.Comments.length;i++){var thisComment=commentData.Comments[i];if(thisComment.CommentKey.Key===commentId){dataContainsCommentId=true;break}comments.push(thisComment)}}if(!dataContainsCommentId){getManyCommentsForAbstractArticlePage(articleId,pageNumber++,instance.TIME_DESCENDING_ORDER,callback,function(){})}else{if(sortOrder===instance.TIME_ASCENDING_ORDER){comments.reverse()}resultCallback(createCommentData(comments,comments.length,commentData.MessageTime))}}callback()}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckDiscoverArticlesService=function(pluckObjectFactory,pluckSender){var findArticles=function(sectionIds,tagIds,numberOfDays,activityType,callback){var responseCallback=function(responseBatch){var articleSummaries=[];var discoveredArticles=responseBatch.Responses[0].DiscoverArticlesAction.DiscoveredArticles;for(var i=0;i<discoveredArticles.length;
i++){articleSummaries.push(buildSummary(discoveredArticles[i]))}callback(articleSummaries)};var sections=pluckObjectFactory.newSectionList(sectionIds);var categories=pluckObjectFactory.newCategoryList(tagIds);var contributors=[];var activity=pluckObjectFactory.newActivity(activityType);var maxResults=10;var discoverArticlesAction=pluckObjectFactory.newDiscoverArticlesAction(sections,categories,contributors,activity,numberOfDays,maxResults);pluckSender.submit(responseCallback,discoverArticlesAction)};this.findMostCommentedArticlesByTag=function(tagId,numberOfDays,callback){findArticles([],[tagId],numberOfDays,"Commented",callback)};this.findMostRecommendedArticlesByTagForLast24Hours=function(tagId,callback){findArticles([],[tagId],1+1,"Recommended",callback)};this.findMostCommentedArticles=function(sectionIds,tagIds,numberOfDays,callback){findArticles(sectionIds,tagIds,numberOfDays,"Commented",callback)};var buildSummary=function(article){return{numberOfComments:article.Comments.NumberOfComments,pageUrl:article.PageUrl,pageTitle:article.PageTitle,numberOfRecommendations:article.Recommendations.NumberOfRecommendations,id:article.ArticleKey.Key}
}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUpdateArticleService=function(pluckObjectFactory,pluckSender){this.update=function(articleInfo,callback){var responseCallback=function(responseBatch){callback()};var updateArticleAction=pluckObjectFactory.newUpdateArticleAction(articleInfo);var contentPolicy=(articleInfo.premoderation)?"ApprovalRequired":"Allowed";var setContentPolicyActionFeaturedUser=pluckObjectFactory.newSetContentPolicyAction(articleInfo.articleId,"Featured","Comment",contentPolicy);var setContentPolicyActionCommentUser=pluckObjectFactory.newSetContentPolicyAction(articleInfo.articleId,"Staff","Comment",contentPolicy);var setContentPolicyActionEditorUser=pluckObjectFactory.newSetContentPolicyAction(articleInfo.articleId,"Editor","Comment",contentPolicy);pluckSender.submit(responseCallback,updateArticleAction,setContentPolicyActionFeaturedUser,setContentPolicyActionCommentUser,setContentPolicyActionEditorUser)}};ensurePackage("guardian.r2.serverSidePluck");
guardian.r2.serverSidePluck.UserCapability={featureComment:[],postComment:["Untrusted","Standard","Contributor","Staff"]};guardian.r2.serverSidePluck.ProfileData=function(userResponseData){var instance=this;function setWebPage(){var webPage=userResponseData.CustomAnswers["Web Page"];instance.webPage=isValidUrl(webPage)?webPage:null}this.hasCapability=function(capability){return arrayContains(guardian.r2.serverSidePluck.UserCapability[capability],instance.userTier)};this.hasNeverCommented=function(){return !instance.userTier};var userTierMap={Anonymous:"Anonymous",Standard:"Banned",Trusted:"Untrusted",Featured:"Standard",Staff:"Contributor",Editor:"Staff"};if(!userResponseData.UserKey){userResponseData.UserKey={}}if(!userResponseData.CustomAnswers){userResponseData.CustomAnswers={}}instance.displayName=userResponseData.DisplayName;instance.location=userResponseData.Location;instance.age=userResponseData.Age;instance.gender=userResponseData.Sex;instance.aboutMe=userResponseData.AboutMe;instance.userId=userResponseData.UserKey.Key;
instance.photoUrl=userResponseData.AvatarPhotoUrl;instance.interests=userResponseData.CustomAnswers.Interests;instance.realName=userResponseData.CustomAnswers["Real Name"];instance.userTier=userTierMap[userResponseData.UserTier];instance.isUntrusted=(instance.userTier==="Untrusted");instance.isStaff=(instance.userTier==="Staff");instance.isContributor=(instance.userTier==="Contributor");instance.isBanned=(instance.userTier==="Banned");instance.isGUFormat=true;setWebPage()};guardian.r2.serverSidePluck.ProfileDataHelper=function(){this.getUserProfileData=function(userResponseData){if(!userResponseData.isGUFormat){return new guardian.r2.serverSidePluck.ProfileData(userResponseData)}else{return userResponseData}};this.convertAuthorInfoInCommentArray=function(commentArray){for(var i=0;i<commentArray.length;i++){commentArray[i].Author=this.getUserProfileData(commentArray[i].Author)}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckObjectFactory=function(config){var instance=this;
this.newCommentPage=function(articleId,numberOfCommentsPerSlice,sliceNumber,sort){return new CommentPage(new ArticleKey(articleId),numberOfCommentsPerSlice,sliceNumber,(sort||"TimeStampAscending"))};this.newUserCommentPage=function(userId,numberOfCommentsPerSlice,sliceNumber,sort){return new UserCommentPage(new UserKey(userId),numberOfCommentsPerSlice,sliceNumber,(sort||"TimeStampDescending"))};this.newRequestBatch=function(data){var requestBatch=new RequestBatch();for(var i=0;i<data.length;i++){requestBatch.AddToRequest(data[i])}return requestBatch};this.newCommentAction=function(articleId,pageUrl,pageTitle,commentBody){var articleKey=new ArticleKey(articleId);return new CommentAction(articleKey,pageUrl,pageTitle,commentBody)};this.newDiscoverArticlesAction=function(sections,categories,contributors,activity,age,maxResults){return new DiscoverArticlesAction(sections,categories,contributors,activity,age,maxResults)};this.newArticleKey=function(articleId){return new ArticleKey(articleId)};
this.newUserKey=function(userId){return new UserKey(userId)};this.newActivity=function(name){return new Activity(name)};this.newCommentKey=function(commentId){return instance.newCommentKeyWithoutPrefix(config.commentKeyPrefix+commentId)};this.newCommentKeyWithoutPrefix=function(commentId){return new CommentKey(commentId)};this.newCustomItemKey=function(key){return new CustomItemKey(key)};this.newSection=function(name){return new Section(name)};this.newSectionList=function(sectionIdList){var sectionList=[];for(var i=0;i<sectionIdList.length;i++){sectionList.push(instance.newSection(sectionIdList[i].toString()))}return sectionList};this.newCategoryList=function(tagIdList){var categoryList=[];for(var i=0;i<tagIdList.length;i++){categoryList.push(instance.newCategory(tagIdList[i].toString()))}return categoryList};this.newCategory=function(name){return new Category(name)};this.articleByDefault={};this.userByDefault={};this.newPluckKey=function(keyString,articleOrUserByDefault){if(keyString&&keyString.match(/^CommentKey/)){return new CommentKey(keyString)
}if(articleOrUserByDefault===instance.articleByDefault){return new ArticleKey(keyString)}if(articleOrUserByDefault===instance.userByDefault){return new UserKey(keyString)}};this.newReportAbuseAction=function(abuseReport){var description=abuseReport.description;if(abuseReport.email){description+=" ["+abuseReport.email+"]"}return new ReportAbuseAction(instance.newPluckKey(abuseReport.commentKey,instance.userByDefault),abuseReport.reason,description)};this.newRecommendActionForComment=function(commentId){return instance.newRecommendAction(instance.newCommentKeyWithoutPrefix(commentId))};this.newRecommendActionForArticle=function(articleId){return instance.newRecommendAction(instance.newArticleKey(articleId))};this.newRecommendAction=function(recommendedItemKey){return new RecommendAction(recommendedItemKey)};this.newUpdateArticleAction=function(articleInfo){var articleKey=instance.newArticleKey(articleInfo.articleId);var section=instance.newSection(articleInfo.section);var categories=[];for(var i=0;
articleInfo.categories&&i<articleInfo.categories.length;i++){categories[i]=instance.newCategory(articleInfo.categories[i])}return new UpdateArticleAction(articleKey,articleInfo.pageUrl,articleInfo.pageTitle,section,categories)};this.newSearchAction=function(searchString,numberOfCommentsPerPage,onPage){var searchType="Comment";return new SearchAction(searchType,searchString,numberOfCommentsPerPage,onPage)};this.newUpdateCustomItemAction=function(customItemKey,content){var name="placeholder";return new UpdateCustomItemAction(customItemKey,name,null,null,content)};this.newUserTier=function(userTier){return new UserTier(userTier)};this.newContentPolicyActionType=function(contentPolicyActionType){return new ContentPolicyActionType(contentPolicyActionType)};this.newContentPolicy=function(contentPolicy){return new ContentPolicy(contentPolicy)};this.newSetContentPolicyAction=function(articleId,userTierString,actionTypeString,contentPolicyString){var articleKey=instance.newArticleKey(articleId);
var userTier=instance.newUserTier(userTierString);var actionType=instance.newContentPolicyActionType(actionTypeString);var contentPolicy=instance.newContentPolicy(contentPolicyString);return new SetContentPolicyAction(articleKey,userTier,actionType,contentPolicy)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckSender=function(pluckObjectFactory,pluckServerUrl,errorMessageView){var instance=this;function handleErrors(callback,errors){if(callback.errorHandler){callback.errorHandler(errors)}else{errorMessageView.writeMessage(errors)}}function createErrorMessage(args,callback,responseBatch){return{args:args,callback:callback,responseBatch:responseBatch,messages:[],hasErrors:function(){return this.messages.length>0}}}this.submit=function(callback){var args=Array.prototype.slice.call(arguments,1);var requestBatch=pluckObjectFactory.newRequestBatch(args);var myCallback=function(responseBatch){var errors=createErrorMessage(args,callback,responseBatch);for(var i=0;
i<responseBatch.Messages.length;i++){var message=responseBatch.Messages[i].Message;if(message!=="ok"){errors.messages.push(message)}}if(errors.hasErrors()){handleErrors(callback,errors)}else{callback(responseBatch)}};requestBatch.BeginRequest(pluckServerUrl,myCallback)};this.submitIndividually=function(callback,messageArray,progressCallback){var responseBatches=[];var numberOfCallbacks=0;var numberOfErrors=0;var expectedNumberOfCallbacks=messageArray.length;var responseCallback=function(responseBatch){responseBatches.push(responseBatch);numberOfCallbacks++;if(progressCallback){progressCallback(responseBatch)}returnResponseBatchesIfNoMoreCallbacks(numberOfCallbacks,responseBatches,expectedNumberOfCallbacks,callback)};responseCallback.errorHandler=function(){numberOfCallbacks++;numberOfErrors++;if(numberOfErrors===expectedNumberOfCallbacks){if(callback.errorHandler){callback.errorHandler()}}else{returnResponseBatchesIfNoMoreCallbacks(numberOfCallbacks,responseBatches,expectedNumberOfCallbacks,callback)
}};for(var i=0;i<messageArray.length;i++){instance.submit(responseCallback,messageArray[i])}};function returnResponseBatchesIfNoMoreCallbacks(numberOfCallbacks,responseBatches,expectedNumberOfCallbacks,callback){if(numberOfCallbacks===expectedNumberOfCallbacks){callback(responseBatches)}}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserCommentService=function(pluckObjectFactory,pluckSender,profilePageUser,config){var numberOfSlicesPerPage=2;var sort="TimeStampDescending";this.getNUserComments=function(n,callback){var startSliceNumber=1;var endSliceNumber=Math.ceil(n/config.pluckMaxNumberPerPage);getUserCommentsForSlices(startSliceNumber,endSliceNumber,callback,n)};this.getUserCommentsForPage=function(pageNumber,callback){if(!pageNumber){pageNumber=1}var endSliceNumber=pageNumber*numberOfSlicesPerPage;var startSliceNumber=endSliceNumber-numberOfSlicesPerPage+1;getUserCommentsForSlices(startSliceNumber,endSliceNumber,callback)};var getUserCommentsForSlices=function(startSliceNumber,endSliceNumber,callback,n){function responseCallback(responseBatches){var userActivities=[];
var messageTime;var totalNumberOfComments=0;var author={displayName:profilePageUser.name};for(var i=0;i<responseBatches.length;i++){messageTime=responseBatches[i].Messages[0].MessageTime;var responses=responseBatches[i].Responses;if(responses.length>0&&responses[0].UserCommentPage.UserActivities){var userCommentPage=responses[0].UserCommentPage;totalNumberOfComments=userCommentPage.NumberOfUserActivities;var activities=userCommentPage.UserActivities;if(activities.length>0){if(activities[0].Comment!==undefined){author=activities[0].Comment.Author}else{if(activities[0].ForumDiscussion!==undefined){author=activities[0].ForumDiscussion.LiteUser}else{if(activities[0].ForumPost!==undefined){author=activities[0].ForumPost.LiteUser}}}userActivities[userCommentPage.OnPage-startSliceNumber]=userCommentPage.UserActivities}}}var allUserActivities=mergeUserActivities(userActivities);callback(createUserActivityData(allUserActivities,author,totalNumberOfComments,messageTime))}delegateErrorHandler(responseCallback,callback);
var userCommentPages=[];for(var sliceNum=startSliceNumber;sliceNum<=endSliceNumber;sliceNum++){var numberOfCommentsPerSlice=getNumberOfCommentsPerSlice(sliceNum,n);userCommentPages.push(pluckObjectFactory.newUserCommentPage(profilePageUser.id,numberOfCommentsPerSlice,sliceNum,sort))}pluckSender.submitIndividually(responseCallback,userCommentPages)};var getNumberOfCommentsPerSlice=function(sliceNum,n){if(!n||sliceNum*config.pluckMaxNumberPerPage<=n){return config.pluckMaxNumberPerPage}else{return n%config.pluckMaxNumberPerPage}};var mergeUserActivities=function(userActivities){var allUserActivities=[];for(var i=0;i<userActivities.length;i++){if(userActivities[i]){allUserActivities=allUserActivities.concat(userActivities[i])}}return allUserActivities};var createUserActivityData=function(userActivities,author,totalNumberOfComments,messageTime){return{UserActivities:userActivities,MessageTime:messageTime,TotalNumberOfComments:totalNumberOfComments,author:author}}};ensurePackage("guardian.r2.serverSidePluck");
guardian.r2.serverSidePluck.PluckPostCommentService=function(config,pluckObjectFactory,pluckSender){this.postComment=function(articleInfo,commentBody,callback){var articleId=articleInfo.articleId;var pageUrl=articleInfo.pageUrl;var pageTitle=articleInfo.pageTitle;var responseCallback=function(responseBatch){var numberOfComments=responseBatch.Responses[0].Article.Comments.NumberOfComments;var totalNumberOfPages=Math.ceil(numberOfComments/config.numberOfCommentsPerPage);callback(totalNumberOfPages)};delegateErrorHandler(responseCallback,callback);var commentAction=pluckObjectFactory.newCommentAction(articleId,pageUrl,pageTitle,commentBody);var articleKey=pluckObjectFactory.newArticleKey(articleId);pluckSender.submit(responseCallback,commentAction,articleKey)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckSearchService=function(pluckObjectFactory,pluckSender,pluckArticleService,pluckSearchTermExtractor,numberOfCommentsPerPage,userProfileUrlPrefix){function getUniqueArticleIds(searchResults){var articleIds={};
for(var i=0;i<searchResults.length;i++){articleIds[searchResults[i].CommentedOnKey]=true}var articleIdsSet=[];for(var key in articleIds){if(articleIds.hasOwnProperty(key)){articleIdsSet.push(key)}}return articleIdsSet}function getSearchResult(searchString,responseBatch){var searchResult=responseBatch.Responses[0].SearchResult;searchResult.MessageTime=responseBatch.Messages[0].MessageTime;searchResult.SearchTokens=pluckSearchTermExtractor.extractTokens(searchString);searchResult.UserProfileUrlPrefix=userProfileUrlPrefix;return searchResult}this.searchComments=function(searchString,onPage,searchServiceCallback){var searchAction=pluckObjectFactory.newSearchAction(searchString,numberOfCommentsPerPage,onPage);function pluckSenderCallback(responseBatch){var profileDataHelper=new guardian.r2.serverSidePluck.ProfileDataHelper();profileDataHelper.convertAuthorInfoInCommentArray(responseBatch.Responses[0].SearchResult.SearchResults);var searchResult=getSearchResult(searchString,responseBatch);function articleSummaryCallback(articleSummaries){var articleSummaryMap={};
for(var j=0;j<articleSummaries.length;j++){articleSummaryMap[articleSummaries[j].articleId]=articleSummaries[j]}for(var i=0;i<searchResult.SearchResults.length;i++){var articleId=searchResult.SearchResults[i].CommentedOnKey;searchResult.SearchResults[i].ArticleSummary=articleSummaryMap[articleId]}searchServiceCallback(responseBatch)}if(searchResult.SearchResults.length===0){searchServiceCallback(responseBatch);return }var articleIds=getUniqueArticleIds(searchResult.SearchResults);pluckArticleService.getArticleSummaries(articleIds,articleSummaryCallback,true)}delegateErrorHandler(pluckSenderCallback,searchServiceCallback);pluckSender.submit(pluckSenderCallback,searchAction)}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.PluckUserCommentServiceAdapter=function(delegate,profilePageUser){this.getNUserComments=function(n,callback){delegate.getNUserComments(n,callback)};this.getUserCommentsForPage=function(pageNumber,callback){var url="http://www.gudevlocal.gnl:8080/pluck-adapter/user/"+profilePageUser.id+"/page/"+pageNumber;
var ajaxRequest=new guardian.r2.ajax.Request(url,{method:"get",onSuccess:function(transport){callback(JSON.parse(transport.responseText))}})}};ensurePackage("guardian.r2.serverSidePluck");guardian.r2.serverSidePluck.R2CommentDataService=function(r2CommentDataServiceUrl,pageId){var articleKeys={};this.getCommentKeywords=function(pluckCommentData,renderKeywordsFunc){var articleIds=getArticleIdsFromCommentData(pluckCommentData);var url=createCommentKeywordRequest(articleIds);var ajaxRequest=new guardian.r2.ajax.Request(url,{method:"get",onSuccess:function(transport){var pattern=/<article id="(\d*)">([\w\W]*?)<\/article>/g;transport.responseText.replace(pattern,function(m,articleId,keywordsHtml){for(var commentKey in articleKeys){if(articleKeys[commentKey]===articleId){renderKeywordsFunc(commentKey,keywordsHtml)}}})}})};var getArticleIdsFromCommentData=function(pluckCommentData){var isAnArticleId="is_an_article_id";var setOfArticleIds={};for(var i=0;i<pluckCommentData.UserActivities.length;
i++){if(pluckCommentData.UserActivities[i].Comment!==undefined){articleKeys[pluckCommentData.UserActivities[i].Comment.CommentKey.Key]=pluckCommentData.UserActivities[i].Comment.CommentedOnKey;setOfArticleIds[pluckCommentData.UserActivities[i].Comment.CommentedOnKey]=isAnArticleId}}var articleIds=[];for(var articleId in setOfArticleIds){if(setOfArticleIds[articleId]===isAnArticleId){articleIds.push(articleId)}}return articleIds};var createCommentKeywordRequest=function(articleIds){var stringToAppend="?pageId="+pageId;for(var i=0;i<articleIds.length;i++){stringToAppend+="&contentId="+articleIds[i]}return r2CommentDataServiceUrl+stringToAppend}};